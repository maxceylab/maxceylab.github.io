<!-- Paul Scotti 2019 -->
<!-- Set code as .html file -->
<html>

<!-- Preload javascript and css files -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
  <script src="https://maxceylab.github.io/expts/js_code/jquery.min.js"></script>
  <script src="https://maxceylab.github.io/expts/js_code/seedrandom.js"></script>
  <script src="https://maxceylab.github.io/expts/js_code/chance.js"></script>
  <script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/TimTurkTools.js"></script>
  <script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/jcanvas.min.js"></script>
  <script>
  let WORKERID = (IsOnTurk()) ? GetWorkerId() : prompt("You don't look like an mTurker! " +
      "Enter an ID to save your data with (any number/string will do). Note your id is used to seed the experiment rng:", "workID");
  let ASSIGNMENTID = (IsOnTurk()) ? GetAssignmentId() : prompt("Set assignment number (doesnt matter for testing):", "assignmentId");
  const startDate = new Date(); const chance1 = Chance(WORKERID); Math.seedrandom(chance1.seed); // Use current workerid as the shuffle seed, so you can trace back their trials</script>
  <script src="https://maxceylab.github.io/expts/js_code/lodash.core.js">// Allows _clone</script>

  <!-- Preload images -->
  <script src="https://maxceylab.github.io/expts/retrieval/loadimg.js"></script>
  <script src="https://maxceylab.github.io/expts/retrieval/initVariables2.js"> </script>

  <!-- load Firebase server javascript, we are using it for storage -->
  <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>

  <link rel="stylesheet" type="text/css" href="https://maxceylab.github.io/expts/retrieval/contReport.css">
  <link rel="stylesheet" type="text/css" href="https://maxceylab.github.io/expts/retrieval/showTrials.css">
  <link rel="stylesheet" type="text/css" href="https://maxceylab.github.io/expts/retrieval/experiment.css">

</head>

<body>
  <!-- Consent statement: -->
  <div id="consentDiv"><h1>The Ohio State University Consent to Participate in Research</h1><h2>Study Title: Individual variation in attention, cognitive control, and memory</h2><h2>Researchers: Paul S. Scotti, Yoolim Hong, Julie D. Golomb, Andrew B. Leber</h2> <p><b>This is a consent form for research participation.</b> It contains important information about this study and what to expect if you decide to participate.</p><p><b>Your participation is voluntary.</b></p><p>Please consider the information carefully. Feel free to email questions to the researchers before making your decision whether or not to participate.  If you decide to participate, you will be asked to click a button below this form.</p><p><b>Purpose:</b> In this experiment, we are interested in understanding how humans are able to control their attention to focus on relevant information, and how attention is related to other cognitive abilities and traits.</p><p><b>Procedures/Tasks:</b> Your participation involves watching various visual events on a computer screen and responding to what you saw. Additionally, you may be asked to complete a survey. You will be provided with detailed written instructions at the start of each task or survey.</p><p><b>Duration:</b> The experiment is expected to take the duration listed in the HIT description. You may leave the study at any time.  If you decide to stop participating in the study, there will be no penalty to you, and you will not lose any benefits to which you are otherwise entitled.  Your decision will not affect your future relationship with The Ohio State University.</p><p><b>Risks and Benefits:</b> There is no more risk associated with participation than you would normally encounter while playing a simple video game.  Benefits include advance scientific knowledge, experiencing the research process, and learning about attention and cognitive control.</p><p><b>Confidentiality:</b> Upon completed of the HIT, your Amazon Mechanical Turk Worker ID will be made available to the experimenters. Only select lab personnel will have access to the requester Mechanical Turk site, and Worker IDs will be used only to confirm study completion, assign compensation, and, in some cases, to invite you to participate in a follow-up study.</p><p>The data that you provide in the experiment will be stored temporarily on a secure private online server or on the web-survey platform Qualtrics, then transferred to our secure lab computers. Your name or contact information will not be collected during the experiment. Only select lab personnel who have received training in human subjects protection and clearance to handle data for this project will have access to your results. We will work to make sure that no one sees your data without approval. But, because we are using the Internet, there is a chance that someone could access your online responses without permission. In some cases, this information could be used to identify you. Your data will be protected with a code to reduce the risk that other people can view the responses. However, there are rare instances when the researcher may be required to share personally identifiable information. For example, in response to a complaint about the research, officials at The University and/or regulatory oversight government agencies (National Science Foundation) may access research data.  The researcher is also required by law to report certain information to government and/or law enforcement officials (e.g., threatened violence against self or others, communicable diseases).</p><p><b>Incentives:</b> You will receive the compensation amount listed in the HIT description (based on a rate of $6/hour). If you withdraw early for any reason, your payment will be prorated to the nearest increment of 10 minutes based on a $6/hour rate, up until the amount indicated in the HIT description. If you withdraw early, please contact the researcher at scotti.5@osu.edu to ensure you receive your compensation.</p><p><b>Participant Rights:</b> You may refuse to participate in this study without penalty or loss of benefits to which you are otherwise entitled. If you are a student or employee at Ohio State, your decision will not affect your grades or employment status.</p><p>If you choose to participate in the study, you may discontinue participation at any time without penalty or loss of benefits.  By consenting below, you do not give up any personal legal rights you may have as a participant in this study.</p><p>An Institutional Review Board responsible for human subjects research at The Ohio State University reviewed this research project and found it to be acceptable, according to applicable state and federal regulations and University policies designed to protect the rights and welfare of participants in research.</p><p><b>Contacts and Questions:</b> For questions, concerns, or complaints about the study, or you feel you have been harmed as a result of study participation, you may contact either Paul Scotti at scotti.5@osu.edu. For questions about your rights as a participant in this study or to discuss other study-related concerns or complaints with someone who is not part of the research team, you may contact Ms. Sandra Meadows in the Office of Responsible Research Practices at meadows.8@osu.edu.</p><p><b>Electronic consent:</b> You may print a copy of this consent form for your records. If you wish to continue with the experiment, please click the button below.<br><center><b>Clicking the button below indicates that:</b><br>You have read the above information<br>You are 18 years of age or older<br>You voluntarily agree to participate<br></p><br></center><p style="text-align: center"><a href="javascript:void(0);" onclick="$('#consentDiv').hide();$('#instructions').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton" style="display: inline;">I consent to participate in this study</a></p></div>

  <!-- Instructions page1 -->
  <div id="instructions" style="display: none">
    <center>
        <p>This HIT is a memorization experiment involving visual images. It will take approximately 1 hour to complete. If you have previously completed this HIT in the last 30 days, you are ineligible to participate again.</p>
      </center>
    <p style="text-align: center"><a href="javascript:void(0)" onclick="$('#instructions').hide();$('#instructions2').show();document.body.scrollTop = document.documentElement.scrollTop = 0;GetInfo();" id="TextButton">Next (1 of 4)</a></p>
  </div>

  <!-- Instructions page2 -->
  <div id="instructions2" style="display:none">
    <center>
        <p>You will be presented with 72 objects, one at a time, each presented for 3 seconds.</p>
        <p>Example of an object:</p>

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval1.png" width="600px"></p>

        <p>The task is to study the color and identity of each object for a later memory test. Sometimes objects will repeat, so you may have more than one opportunity to memorize an object.</p>
      </center>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions2').hide();$('#instructions3').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton">Next (2 of 4)</a></p>
  </div>

  <!-- Instructions page3 -->
  <div id="instructions3" style="display:none">
    <center>
        <p>Studied objects will often be similar to each other. For instance, you may encounter several different types of bowties.</p>

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval2.png" width="600px"></p>
        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval3.png" width="600px"></p>

        <p>It is therefore not sufficient to remember "purple bowtie". Your memory will need to be as precise as "striped purple bowtie".</p>
        <p>After you have studied all the objects, we will test your memory.</p>
      </center>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions3').hide();$('#instructions5').show();document.body.scrollTop = document.documentElement.scrollTop = 0;$('a#TextButton').hide();ImagesReady();" id="TextButton">Next (3 of 4)</a></p>
  </div>

  <!-- Instructions page5 -->
  <div id="instructions5" style="display:none">
    <center>
        We will test your memory by presenting a previously seen object in <u>grayscale</u>, surrounded by a color wheel.

        Move your mouse around the color wheel and click what you believe was the original color of the object.</p>

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval7.png" width="600px"></p>

        <p>If you are uncertain of the original color, move your mouse around and click what feels right. Please be as precise as possible in selecting what you think is the object's original color.</p>

        <hr>

        <p><b>The more accurate your responses, the more bonus money you will receive at the end of the HIT (up to $4.00).</b></p>

        <p><b><i>Every</i> object you see will eventually be tested using the color wheel.</b></p>

        <p>Ready to start? You will begin by memorizing a series of colored objects. You are not allowed to use external devices to aid memorization.</p>

        <p><i>Please set aside approximately 1 hour to complete this experiment. Please do your best -- the amount of time we will spend analyzing your data far exceeds 60 minutes! </i></p>
      </center>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions4').hide();document.body.scrollTop = document.documentElement.scrollTop = 0;StartExperiment();" id="TextButton">Start Experiment</a></p>
    <center><p id=loading>Images loading... Please wait a minute or refresh the page.</p></center>
  </div>

  <!-- $('a#TextButton').hide();ImagesReady(); -->

  <!-- Modal Pop-up Box -->
  <div id="openModal" class="modalDialog">
    <div>
      <a href="#close" onclick="modalContinue();" title="Close" class="close">X</a>
      <p id="openModal_text">Hi!</p>
    </div>
  </div>

  <form name="turkSubmit" id="turkSubmit" action="https://www.mturk.com/mturk/externalSubmit" method="POST">
  <input type="hidden" name="assignmentId" id="assignmentId" value="" >
  <input type="hidden" name="foo" value="" >
  <input type="submit" value="Submit" name="submitButton" id="submitButton" style="display: none"></form>

  <!-- Screen after submitting expt -->
  <div id="done">
    <center>
    <div id="cashPrize">text</div>
    </center>
    <div id="doneText">
    </div>
    <div>
      <center>
        <a href="javascript:void(0);" onclick="SaveData()" id="submitForm">Click to Submit</a>
      </center>
    </div>
  </div>
  <div id="saving">Saving . . .</div>
  </div>

  <!-- Display Object HTML -->
  <div id="showTrial">
    <div id="fixation">+</div>
    <div id="allItems">
      <canvas id="itemA" width=300 height=300 style="position:absolute; top:150px; left:150px;"></canvas>
      <img id="CDitem" src="https://maxceylab.github.io/stimuli/change_detection/CDfix.png" width=600 height=600></img>
    </div>
    <canvas id="ringItemA" width=600 height=600 style="position: absolute;"></canvas>
    <div id="pointer"></div>
    <br><br>
    <center>
      <a href="javascript:void(0);" onclick="Unsure();" id="Unsure" style="position:relative; top:585px;">No Idea</a>
      <a href="javascript:void(0);" onclick="Unsureish();" id="Unsureish" style="position:relative; top:585px;">Unconfident</a>
      <a href="javascript:void(0);" onclick="Sureish();" id="Sureish" style="position:relative; top:585px;">Semi-confident</a>
      <a href="javascript:void(0);" onclick="Sure();" id="Sure" style="position:relative; top:585px;">Confident</a>
      <a href="javascript:void(0);" onclick="SamePress();" id="SameButton" style="display: hidden;">Same</a>
      <a href="javascript:void(0);" onclick="DiffPress();" id="DiffButton" style="display: hidden;">Different</a>
    </center>
    <!-- <p id="acctext" align="center" style="position:absolute; top:-10px; right:10px">Accuracy: 100%</p> -->
    <p id="conftext" align="center" style="position:absolute; bottom:0px; left:90px"><b>How confident are you that your response was accurate?</b></p>
  </div>

  <!-- Initializing JS -->
  <script>
    /* Initialize Firebase */
    const config = {
      apiKey: "AIzaSyB4FT9tacVGSKmDyWf203wy7WeiDYCDEFM",
      authDomain: "maxceylab-25a85.firebaseapp.com",
      databaseURL: "https://maxceylab-25a85.firebaseio.com",
      projectId: "maxceylab-25a85",
      storageBucket: "maxceylab-25a85.appspot.com",
      messagingSenderId: "521427523696"
    };
    firebase.initializeApp(config);

    /* Disable context/right-click menu */
    // document.oncontextmenu = function() {
    //     return false;
    // }

    /* Define more variables */
    let modalClosed = false;
    const numStudy = 72; //ACTUALLY 54 TRIALS PER BLOCK, note the .null trial attributes
    const numPractice = 72;
    const numTest = 72;
    const displayTime = 3000; //3000 ms
    let itiTime = 500; //500 ms
    const imgWidth = 300;
    const imgHeight = 300;
    </script>
    <script src="https://maxceylab.github.io/expts/retrieval/colors_blocked.js"> </script>
    <script>
    let curStudy = 0;
    let curPractice = 0;
    let curTest = 0;
    let curBlock = 0;
    let now = new Date().getTime(); // used for 5 min filler task
    let now2 = now;
    let curCD = 0;
    let CDaccuracy = [];
    let CDType = [];
    let PracticeColRT = [];
    let PracticeColResp = [];
    let PracticeColDiff = [];
    let TestColRT = [];
    let TestColResp = [];
    let TestColDiff = [];
    let RepeatColResp = [];
    let RepeatColDiff = [];
    let flip = 0;
    let flipList = [0];
    let randrotate = 0;
    let randrotateList = [];
    const origColors = _.clone(colors); // clone is required to copy a variable without it accidentally referencing the same thing
    let flippedColors = _.clone(colors).reverse();
    flippedColors = flippedColors.concat(flippedColors.splice(0, 180)); // shift array 180
    let tempVar = true;
    let startingColor = -999;
    let mouseMoved = 0;
    let angleDeg = -999;
    const radius = 242;
    const ringSize = 242;
    const centerX = 300;
    const centerY = 300;
    let basepay = 4.5;
    let numRepeats = 0;
    let RepeatObj = [];
    let RepeatCol = [];
    locked = 0;
    let back = 0;
    let count = 0;
    let groundcount = 0;
    let OverallAcc = 0;
    let bonusmultiplier = 4;
    let ongoingacc = 0;

    /* Setup reused image and color ring variables */
    let ringStandard = new Image();
    ringStandard.crossOrigin = "anonymous";
    ringStandard.src = $('#ring')[0].src;
    let ringFlipped = new Image();
    ringFlipped.crossOrigin = "anonymous";
    ringFlipped.src = $('#ringFlip')[0].src;

    /* Setup CD images */
    let imgCD = new Image();
    imgCD.crossOrigin = "anonymous";
    imgCD.src = $('#diff1')[0].src;
    let CDfix = new Image();
    CDfix.crossOrigin = "anonymous";
    CDfix.src = $('#CDfix')[0].src;
    let imgCDtest = new Image();
    imgCDtest.crossOrigin = "anonymous";
    imgCDtest.src = $('#diff1t')[0].src;

    /* Setting up canvas contexts */
    const itemA = document.getElementById("itemA");
    const ctxA = itemA.getContext("2d");
    const ringItemA = document.getElementById("ringItemA");
    const ringctxA = ringItemA.getContext("2d");
    /* Set up non-canvas contexts */
    const CDitem = document.getElementById("CDitem");

    function GetInfo() {
      age = prompt('Before we start, can you tell me how old you are (in years)?');

      while (age > 100 || age < 18 || !(age>=18)) {
        age = prompt('Can you tell me how old you are (e.g., 18, not the year you were born)?');
      }

      if (age > 45) {
        $('body').html('<center><b>Unfortunately, this experiment does not allow participants over 45 years old (we separately study older populations).<br><br>Please return this HIT.<br><br>You will not be paid if you try again and change your age.</b></center>');
      }

      sex = prompt('And are you male (M), female (F), non-binary (B), or prefer not to answer (NA)?');

      while (!(sex == 'M' || sex == 'F' || sex == 'B' || sex == 'NA' || sex == 'm' || sex == 'f' || sex == 'b' || sex == 'na' || sex == 'female' || sex == 'male' || sex == 'Female' || sex == 'Male')) {
        sex = prompt('Are you male (M), female (F), non-binary (B), or prefer not to answer (NA)? Type one of the options shown in parentheses.');
      }
      if (sex == 'M' || sex == 'm' || sex == 'male' || sex == 'Male') {
        sex = 'm';
      } else if (sex == 'F' || sex == 'f' || sex == 'female' || sex == 'Female') {
        sex = 'f';
      } else if (sex == 'B' || sex == 'b') {
        sex = 'b';
      } else if (sex == 'NA' || sex == 'na') {
        sex = 'na';
      }
    }

    /* Start Experiment */
    function StartExperiment() {
      if (IsOnTurk() && IsTurkPreview()) {
          alert("Please accept the HIT before continuing.");
          return false;
      }

      // save a file letting me know that someone made it this far
      const blobx = new Blob([JSON.stringify(chance1.seed)], {
        type: "application/json"
      });
      const storageRefx = firebase.storage().ref('started_retrieval_mturk/' + WORKERID + '.json');
      storageRefx.put(blobx);

      $('#instructions5').hide();
      $('#pointer').hide();
      $('#ringItemA').hide();

      $('#Unsure').hide();
      $('#Unsureish').hide();
      $('#Sureish').hide();
      $('#Sure').hide();
      $('#conftext').hide();

      // open pop-up:
      modalClosed = false;
      document.getElementById("openModal_text").innerHTML = 'Experiment will now begin. Good luck!';
      window.location.href = '#openModal';
      checkFlag1();

      function checkFlag1() {
        if (modalClosed == false) {
          window.setTimeout(checkFlag1, 100); /* this checks the flag every 100 milliseconds*/
        } else {
          $('#showTrial').show();
          NextStudyTrial();
        }
      }

    }

    /* Study Phase Start */
    function NextStudyTrial() {
      if (curStudy >= numStudy && curBlock==3) { // if end of study
        curStudy++;
        locked=0;
        $('#pointer').css('margin-top', 0);

        now = new Date().getTime();
        now2 = now;
        $('#itemA').hide(); // hide object from last trial

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'End of Study Phase! <br><br> Before we test your memory for the studied objects, we will do a short task. <br><br> You will see an array of colored squares appear for a brief moment. Then, one colored square will be presented. The task is to select whether the colored square is the same color or a different color than it was before.';
        window.location.href = '#openModal';
        checkFlag2();
        return;

        function checkFlag2() {
          if (modalClosed == false) {
            window.setTimeout(checkFlag2, 100); /* this checks the flag every 100 milliseconds*/
          } else {
            ChangeDetection(); // start Practice Phase
            return; // need return; otherwise the ShowTrial below executes
          }
        }
      } else {
        if (curStudy == numStudy && curBlock < 3) {
          itiTime = 500;
          // open pop-up:
          modalClosed = false;
          $('#allItems').css('margin-top', -1000);
          if (curBlock==0 && curStudy == numStudy) {
            curBlock = 1;
            curStudy=0;
            document.getElementById("openModal_text").innerHTML = 'You are 1/4 of the way through the study phase. Take a short break if you want, and then close this pop-up to continue.';
          } else if (curBlock==1 && curStudy == numStudy){
            curBlock = 2;
            curStudy=0;
            document.getElementById("openModal_text").innerHTML = 'You are 2/4 of the way through the study phase. Take a short break if you want, and then close this pop-up to continue.';
          } else if (curBlock==2 && curStudy == numStudy){
            curBlock = 3;
            curStudy=0;
            document.getElementById("openModal_text").innerHTML = 'You are 3/4 of the way through the study phase. Take a short break if you want, and then close this pop-up to continue.';
          }
          window.location.href = '#openModal';
          checkFlagBreak();

          function checkFlagBreak() {
            if (modalClosed == false) {
              window.setTimeout(checkFlagBreak, 100); /* this checks the flag every 100 milliseconds*/
            } else {
              // Preload the image of next trial
              if (StudyTrials[curBlock][curStudy].null==1) {
                itiTime = 0;
                curStudy++;
                NextStudyTrial();
                return;
              }
              start(ctxA, StudyTrials[curBlock][curStudy].color, 0, 0, imgWidth, imgHeight, 0, StudyTrials[curBlock][curStudy].img, itemA);
              setTimeout(function() {
                itiTime = 500;
                ShowStudy();
              }, itiTime/2); // wait a tad just to ensure image got switch
            }
          }
        } else {
          // Preload the image of next trial
          if (StudyTrials[curBlock][curStudy].null==1) {
            itiTime = 0;
            curStudy++;
            NextStudyTrial();
            return;
          }
          start(ctxA, StudyTrials[curBlock][curStudy].color, 0, 0, imgWidth, imgHeight, 0, StudyTrials[curBlock][curStudy].img, itemA);
          setTimeout(function() {
            itiTime = 500;
            ShowStudy();
          }, itiTime/2); // wait a tad just to ensure image got switch
        }
      }
    }

    /* Display Object */
    function ShowStudy() {
      $('#allItems').css('margin-top', 0);
      setTimeout(function() {
        $('#allItems').css('margin-top', -1000);
        setTimeout(function() {
          if (curStudy > 0) {
            if (StudyTrials[curBlock][curStudy-1].null==0) {
              back = 1;
            } else if (StudyTrials[curBlock][curStudy-2].null==0) {
              back = 2;
            } else if (StudyTrials[curBlock][curStudy-3].null==0) {
              back = 3;
            } else if (StudyTrials[curBlock][curStudy-4].null==0) {
              back = 4;
            } else if (StudyTrials[curBlock][curStudy-5].null==0) {
              back = 5;
            }
            if (StudyTrials[curBlock][curStudy-back].type==3 && locked==0 && StudyTrials[curBlock][curStudy-back].null==0) {
              locked=1;
              numRepeats = numRepeats+1;
              start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, StudyTrials[curBlock][curStudy-back].img, itemA);
              RepeatObj.push(StudyTrials[curBlock][curStudy-back].id);
              RepeatCol.push(StudyTrials[curBlock][curStudy-back].color);
              $('#allItems').css('margin-top', 0);
              $('#pointer').css('margin-top', 0);
              // open pop-up:
              modalClosed = false;
              document.getElementById("openModal_text").innerHTML =
                'Sometimes we will interrupt to gauge your attention. The object from two presentations prior will now appear in grayscale and your task is to click its original color.';
              window.location.href = '#openModal';
              checkFlagCont();

              function checkFlagCont() {
                if (modalClosed == false) {
                  window.setTimeout(checkFlagCont, 100); /* this checks the flag every 100 milliseconds*/
                } else {
                  flip = Math.round(Math.random());
                  flipList.push(flip);
                  randrotate = Math.floor(Math.random() * 360);
                  randrotateList.push(randrotate);
                  ringctxA.clearRect(0, 0, 600, 600);
                  ringctxA.restore();
                  ringctxA.save();
                  ringctxA.translate(50 + 500 / 2, 50 + 500 / 2);
                  ringctxA.rotate(randrotate * Math.PI / 180);
                  ringctxA.translate(-50 - 500 / 2, -50 - 500 / 2);
                  Continuous();
                }
              }
              return;
            } else {
              locked=0;
              curStudy++;
              NextStudyTrial();
              return;
            }
          } else {
            locked=0;
            curStudy++;
            NextStudyTrial();
            return;
          }
        }, itiTime/2); // fulfill rest of itiTime before showing study image
      }, displayTime);
    }

    /* Practice Phase Start */
    function NextPracTrial() {
      if (curPractice == numPractice && curBlock==0) {
        curBlock = 1;
        curPractice = 0;
      } else if (curPractice == numPractice && curBlock==1) {
        curBlock = 2;
        curPractice = 0;
      }
      $(document).unbind('mousemove.curTrial');
      $(document).unbind('mouseup.curTrial');
      $('#allItems').css('margin-top', -1000);

      if (curPractice < numPractice) {
        // Preload the image of next trial
        start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, PracticeTrials[curBlock][curPractice].img, itemA);
      }

      setTimeout(function() {
        if (curPractice >= numPractice && curBlock==2) { // if end of practice
          curPractice++;

          now = new Date().getTime();
          now2 = now;
          itiTime = 500;
          $('#itemA').hide(); // hide object from last trial
          $('#ringItemA').hide();

          // open pop-up:
          modalClosed = false;
          document.getElementById("openModal_text").innerHTML =
            'Good work so far! <br> We will continue to test your memory after some more change detection trials.';
          window.location.href = '#openModal';
          checkFlag3();
          return;

          function checkFlag3() {
            if (modalClosed == false) {
              window.setTimeout(checkFlag3, 100); /* this checks the flag every 100 milliseconds*/
            } else {
              ChangeDetection(); // start filler task
              return; // need return; otherwise function below executes
            }
          }
        } else if (PracticeTrials[curBlock][curPractice].null==1) {
          itiTime = 0;
          curPractice++;
          NextPracTrial();
          return;
        }
        if (curPractice < numPractice) {
          itiTime = 500;
          OldNewJudgment();
        }
      }, itiTime);
    }

    function Continuous() {
      $('#ringItemA').show();
      $('#CDitem').hide();
      $('#pointer').css('margin-top', 0);

      flip == 0 ? ringctxA.drawImage(ringStandard, 50, 50, 500, 500) : ringctxA.drawImage(ringFlipped, 50, 50, 500, 500);

      mouseInit = mouseX;
      imgNum = Math.floor(chance1.random()*360);
      mouseMoved = 0;
      angleDeg = 0;
      startTimeC = new Date();

      $(document).bind('mousemove.curTrial', function(e) {
        parentOffset = $('#showTrial').offset();
        relX = e.pageX - parentOffset.left - centerX;
        relY = e.pageY - parentOffset.top - centerY;
        curAngle = Math.atan2(relY, relX);
        angleDeg = curAngle / Math.PI * 180.0;
        if (mouseMoved == 0) {
            if (mouseInit != mouseX) {
                setTimeout(function() {
                    imgNum = Math.round(wrap([angleDeg - randrotate]));
                    startingColor = imgNum;
                    mouseMoved = 1;
                    // start(ctxA, imgNum, 0, 0, imgWidth, imgHeight, flip, imageDic[curDic], itemA);
                }, 400);
            }
        } else {
            imgNum = Math.round(wrap([angleDeg - randrotate]));
            // start(ctxA, imgNum, 0, 0, imgWidth, imgHeight, flip, imageDic[curDic], itemA);
        }
        $('#pointer').css({
            'left': centerX + Math.cos(curAngle) * ringSize - 9,
            'top': centerY + Math.sin(curAngle) * ringSize - 9
        });
        $('#pointer').show();
      });
      $(document).bind('mouseup.curTrial', function(e) {
        if (new Date() - startTimeC > 750) {
          if (locked==1) { // study phase
            $(document).unbind('mousemove.curTrial');
            $(document).unbind('mouseup.curTrial');
            if (flip == 1) {
              a = origColors[arrayContains(flippedColors[wrap(imgNum)],origColors)];
              imgNum = origColors.findIndex(k => k==a);
            }
            RepeatColResp.push(wrap(imgNum));
            RepeatColDiff.push(wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color));
            StudyTrials[curBlock][curStudy-back].resp = wrap(imgNum);
            StudyTrials[curBlock][curStudy-back].diff = wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color);
            $('#Unsure').show();
            $('#Unsureish').show();
            $('#Sureish').show();
            $('#Sure').show();
            $('#conftext').show();
            return;
          } else if (curPractice > numPractice && locked==0) { // if test phase
            $(document).unbind('mousemove.curTrial');
            $(document).unbind('mouseup.curTrial');
            TestColRT.push(new Date() - startTimeC);
            if (flip == 1) {
              a = origColors[arrayContains(flippedColors[wrap(imgNum)],origColors)];
              imgNum = origColors.findIndex(k => k==a);
            }
            // if (wrapDiff(imgNum,TestTrials[curTest].color) <= 30) {
            //   alert('You were ' + wrapDiff(imgNum,TestTrials[curTest].color) + ' degrees away. Great!')
            // } else {
            //   alert('You were ' + wrapDiff(imgNum,TestTrials[curTest].color) + ' degrees away. Not quite...')
            // }
            TestColResp.push(wrap(imgNum));
            TestColDiff.push(wrapDiff(imgNum,TestTrials[curTest].color));
            TestTrials[curTest].resp = wrap(imgNum);
            TestTrials[curTest].diff = wrapDiff(imgNum,TestTrials[curTest].color);
            $('#Unsure').show();
            $('#Unsureish').show();
            $('#Sureish').show();
            $('#Sure').show();
            $('#conftext').show();
            return;
          } else { // if practice phase
            $(document).unbind('mousemove.curTrial');
            $(document).unbind('mouseup.curTrial');
            PracticeColRT.push(new Date() - startTimeC);
            if (flip == 1) {
              a = origColors[arrayContains(flippedColors[wrap(imgNum)],origColors)];
              imgNum = origColors.findIndex(k => k==a);
            }
            // if (wrapDiff(imgNum,PracticeTrials[curBlock][curPractice].color) <= 30) {
            //   alert('You were ' + wrapDiff(imgNum,PracticeTrials[curBlock][curPractice].color) + ' degrees away. Great!')
            // } else {
            //   alert('You were ' + wrapDiff(imgNum,PracticeTrials[curBlock][curPractice].color) + ' degrees away. Not quite...')
            // }
            PracticeColResp.push(wrap(imgNum));
            PracticeColDiff.push(wrapDiff(imgNum,PracticeTrials[curBlock][curPractice].color));
            PracticeTrials[curBlock][curPractice].resp = wrap(imgNum);
            PracticeTrials[curBlock][curPractice].diff = wrapDiff(imgNum,PracticeTrials[curBlock][curPractice].color);
            $('#Unsure').show();
            $('#Unsureish').show();
            $('#Sureish').show();
            $('#Sure').show();
            $('#conftext').show();
            return;
          }
        };
      });
    }

    /* Display Object & Old/New Judgment */
    function OldNewJudgment() {
      startTrial = new Date().getTime();
      $('#CDitem').show();
      if (TestTrials[curTest].type < 4) {
        // display OLD
        flip = Math.round(Math.random());
        randrotate = Math.floor(Math.random() * 360);
        ringctxA.clearRect(0, 0, 600, 600);
        ringctxA.restore();
        ringctxA.save();
        ringctxA.translate(50 + 500 / 2, 50 + 500 / 2);
        ringctxA.rotate(randrotate * Math.PI / 180);
        ringctxA.translate(-50 - 500 / 2, -50 - 500 / 2);
        Continuous();
        $('#allItems').css('margin-top', 0);
      } else {
        // display NEW
        $('#allItems').css('margin-top', 0);
      }
    }

    /* Filler Start */
    function ChangeDetection() {
      curBlock = 0;
      $('#allItems').css('margin-top', 0);
      $('#pointer').css('margin-top', -1000);
      $('#CDitem').show();
      if (now2 < (now + 120000)) { // 120000 for 2 minutes long filler task
        ChangeDetectionTrial();
      } else {
        $('#CDitem').attr('src', CDfix.src); // reset last CD trial to CDfix; make sure all components of CD task are hidden before moving on
        $('#SameButton').hide();
        $('#DiffButton').hide();
        $('#allItems').css('margin-top', -1000); // show object items again and hide them off-screen
        $('#itemA').show();

        // open pop-up:
        modalClosed = false;
        if (curPractice > numPractice) {
          document.getElementById("openModal_text").innerHTML =
            'Great job! <br><br> We will now continue testing your memory. <br><br> You will see a grayscale object and be asked to select the original color on the color wheel. <br><br>  Keep it up, the HIT is almost over!';
        } else {
          document.getElementById("openModal_text").innerHTML =
            'Great job! <br><br> We will now test your memory. <br><br> You will see a grayscale object and be asked to select the original color on the color wheel. <br><br> Good luck!';
        }
        window.location.href = '#openModal';
        checkFlag6();

        function checkFlag6() {
          if (modalClosed == false) {
            window.setTimeout(checkFlag6, 100); /* this checks the flag every 100 milliseconds*/
          } else if (curPractice > numPractice) {
            NextTestTrial();
          } else {
            NextPracTrial();
          }
        }
      }
    }

    // Present CD trial
    function ChangeDetectionTrial() {
      now2 = new Date().getTime();

      if ([0].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // same
        imgCD.src = $('#same' + (curCD % 25 + 1))[0].src; // memory array
        imgCDtest.src = $('#same' + (curCD % 25 + 1) + 't')[0].src; // test array
        CDType.push(0); // record what type of CD trial this was
      } else { //diff
        imgCD.src = $('#diff' + (curCD % 25 + 1))[0].src;
        imgCDtest.src = $('#diff' + (curCD % 25 + 1) + 't')[0].src;
        CDType.push(1);
      }

      $('#CDitem').attr('src', CDfix.src);
      setTimeout(function() { // after 800 ms, show colored memory array
        $('#CDitem').attr('src', imgCD.src);
        setTimeout(function() { // after 500 ms, show fixation again
          $('#CDitem').attr('src', CDfix.src);
          setTimeout(function() { // after 900 ms, show test array
            $('#CDitem').attr('src', imgCDtest.src);
            $('#SameButton').show();
            $('#DiffButton').show();
          }, 900);
        }, 500);
      }, 800);
    }

    // Responses for Change Detection
    function SamePress() {
      if ([0].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // same
        CDaccuracy.push(1);

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'Correct! Keep going!';
        window.location.href = '#openModal';

        checkFlag5();

      } else if ([1].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // diff
        CDaccuracy.push(0);

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'Incorrect...';
        window.location.href = '#openModal';

        checkFlag5();
      }
    }

    function DiffPress() {
      if ([1].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // diff
        CDaccuracy.push(1);

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'Correct! Keep going!';
        window.location.href = '#openModal';

        checkFlag5();
      } else if ([0].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // same
        CDaccuracy.push(0);

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'Incorrect...';
        window.location.href = '#openModal';

        checkFlag5();
      }
    }

    /* Test Phase Start */
    function NextTestTrial() {
      $(document).unbind('mousemove.curTrial');
      $(document).unbind('mouseup.curTrial');
      $('#allItems').css('margin-top', -1000);
      if (curTest < numTest) {
        // Preload the image of next trial
        start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, TestTrials[curTest].img, itemA);
      }

      setTimeout(function() {
        if (TestTrialType[curTest] > 9) {
          start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, flip, TestTrials[curTest].img, itemA);
        }
      }, itiTime+5); // wait a little bit just to make sure image got switched in time

      setTimeout(function() { // fixation at beginning of trial for itiTime
        if (curTest >= numTest) { // if end of test
          itiTime = 500;
          $('#itemA').hide(); // hide object from last trial

          // open pop-up:
          modalClosed = false;
          document.getElementById("openModal_text").innerHTML =
            'End of Experiment!';
          window.location.href = '#openModal';
          checkFlag4();

          function checkFlag4() {
            if (modalClosed == false) {
              window.setTimeout(checkFlag4, 100); /* this checks the flag every 100 milliseconds*/
            } else {
              Done(); // finish up experiment
              return; // need return; otherwise function below executes
            }
          }
          return;
        } else if (TestTrials[curTest].null==1) {
          itiTime = 0;
          curTest++;
          NextTestTrial();
          return;
        }
        itiTime = 500;
        OldNewJudgment();
      }, itiTime);
    }

    function Unsure() {
      $('#pointer').css('margin-top', -1000);
      if (locked==1) {
        StudyTrials[curBlock][curStudy-back].conf = 0;
        if (wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) <= 30) {
          alert('You were ' + wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) + ' degrees away. Great!')
        } else {
          alert('You were ' + wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) + ' degrees away. Not quite...')
        }
        curStudy++;
        setTimeout(function() {
          locked=0;
          $('#ringItemA').hide();
          $('#allItems').css('margin-top', -1000);
          NextStudyTrial();
          return;
        }, itiTime);
      } else if (curPractice > numPractice && locked==0) {
        TestTrials[curTest].conf = 0;
        curTest++;
        NextTestTrial();
      } else {
        PracticeTrials[curBlock][curPractice].conf = 0;
        curPractice++;
        NextPracTrial();
      }
      $('#Unsure').hide();
      $('#Unsureish').hide();
      $('#Sureish').hide();
      $('#Sure').hide();
      $('#conftext').hide();
      if ((PracticeColDiff.length == 0 && TestColDiff.length == 0) || (PracticeColDiff.length != 0 && PracticeColDiff.length % 5 == 0) || (TestColDiff.length != 0 && TestColDiff.length % 5 == 0)) {
        count=0;groundcount=0;
        for(var i = 0; i < RepeatColDiff.length; ++i){
            count=count+RepeatColDiff[i];
            groundcount=groundcount+180;
        }
        for(var i = 0; i < PracticeColDiff.length; ++i){
            count=count+PracticeColDiff[i];
            groundcount=groundcount+180;
        }
        for(var i = 0; i < TestColDiff.length; ++i){
          count=count+TestColDiff[i];
          groundcount=groundcount+180;
        }
        ongoingacc = 100*(1-(count/groundcount));
        // document.getElementById("acctext").innerHTML = 'Accuracy: ' + ongoingacc.toFixed(2) + '%';
      }
    }
    function Unsureish() {
      $('#pointer').css('margin-top', -1000);
      if (locked==1) {
        StudyTrials[curBlock][curStudy-back].conf = 1;
        if (wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) <= 30) {
          alert('You were ' + wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) + ' degrees away. Great!')
        } else {
          alert('You were ' + wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) + ' degrees away. Not quite...')
        }
        curStudy++;
        setTimeout(function() {
          locked=0;
          $('#ringItemA').hide();
          $('#allItems').css('margin-top', -1000);
          NextStudyTrial();
          return;
        }, itiTime);
      } else if (curPractice > numPractice && locked==0) {
        TestTrials[curTest].conf = 1;
        curTest++;
        NextTestTrial();
      } else {
        PracticeTrials[curBlock][curPractice].conf = 1;
        curPractice++;
        NextPracTrial();
      }
      $('#Unsure').hide();
      $('#Unsureish').hide();
      $('#Sureish').hide();
      $('#Sure').hide();
      $('#conftext').hide();
      if ((PracticeColDiff.length == 0 && TestColDiff.length == 0) || (PracticeColDiff.length != 0 && PracticeColDiff.length % 5 == 0) || (TestColDiff.length != 0 && TestColDiff.length % 5 == 0)) {
        count=0;groundcount=0;
        for(var i = 0; i < RepeatColDiff.length; ++i){
            count=count+RepeatColDiff[i];
            groundcount=groundcount+180;
        }
        for(var i = 0; i < PracticeColDiff.length; ++i){
            count=count+PracticeColDiff[i];
            groundcount=groundcount+180;
        }
        for(var i = 0; i < TestColDiff.length; ++i){
          count=count+TestColDiff[i];
          groundcount=groundcount+180;
        }
        ongoingacc = 100*(1-(count/groundcount));
        // document.getElementById("acctext").innerHTML = 'Accuracy: ' + ongoingacc.toFixed(2) + '%';
      }
    }
    function Sureish() {
      $('#pointer').css('margin-top', -1000);
      if (locked==1) {
        StudyTrials[curBlock][curStudy-back].conf = 2;
        if (wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) <= 30) {
          alert('You were ' + wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) + ' degrees away. Great!')
        } else {
          alert('You were ' + wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) + ' degrees away. Not quite...')
        }
        curStudy++;
        setTimeout(function() {
          locked=0;
          $('#ringItemA').hide();
          $('#allItems').css('margin-top', -1000);
          NextStudyTrial();
          return;
        }, itiTime);
      } else if (curPractice > numPractice && locked==0) {
        TestTrials[curTest].conf = 2;
        curTest++;
        NextTestTrial();
      } else {
        PracticeTrials[curBlock][curPractice].conf = 2;
        curPractice++;
        NextPracTrial();
      }
      $('#Unsure').hide();
      $('#Unsureish').hide();
      $('#Sureish').hide();
      $('#Sure').hide();
      $('#conftext').hide();
      if ((PracticeColDiff.length == 0 && TestColDiff.length == 0) || (PracticeColDiff.length != 0 && PracticeColDiff.length % 5 == 0) || (TestColDiff.length != 0 && TestColDiff.length % 5 == 0)) {
        count=0;groundcount=0;
        for(var i = 0; i < RepeatColDiff.length; ++i){
            count=count+RepeatColDiff[i];
            groundcount=groundcount+180;
        }
        for(var i = 0; i < PracticeColDiff.length; ++i){
            count=count+PracticeColDiff[i];
            groundcount=groundcount+180;
        }
        for(var i = 0; i < TestColDiff.length; ++i){
          count=count+TestColDiff[i];
          groundcount=groundcount+180;
        }
        ongoingacc = 100*(1-(count/groundcount));
        // document.getElementById("acctext").innerHTML = 'Accuracy: ' + ongoingacc.toFixed(2) + '%';
      }
    }
    function Sure() {
      $('#pointer').css('margin-top', -1000);
      if (locked==1) {
        StudyTrials[curBlock][curStudy-back].conf = 3;
        if (wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) <= 30) {
          alert('You were ' + wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) + ' degrees away. Great!')
        } else {
          alert('You were ' + wrapDiff(imgNum,StudyTrials[curBlock][curStudy-back].color) + ' degrees away. Not quite...')
        }
        curStudy++;
        setTimeout(function() {
          locked=0;
          $('#ringItemA').hide();
          $('#allItems').css('margin-top', -1000);
          NextStudyTrial();
          return;
        }, itiTime);
      } else if (curPractice > numPractice && locked==0) {
        TestTrials[curTest].conf = 3;
        curTest++;
        NextTestTrial();
      } else {
        PracticeTrials[curBlock][curPractice].conf = 3;
        curPractice++;
        NextPracTrial();
      }
      $('#Unsure').hide();
      $('#Unsureish').hide();
      $('#Sureish').hide();
      $('#Sure').hide();
      $('#conftext').hide();
      if ((PracticeColDiff.length == 0 && TestColDiff.length == 0) || (PracticeColDiff.length != 0 && PracticeColDiff.length % 5 == 0) || (TestColDiff.length != 0 && TestColDiff.length % 5 == 0)) {
        count=0;groundcount=0;
        for(var i = 0; i < RepeatColDiff.length; ++i){
            count=count+RepeatColDiff[i];
            groundcount=groundcount+180;
        }
        for(var i = 0; i < PracticeColDiff.length; ++i){
            count=count+PracticeColDiff[i];
            groundcount=groundcount+180;
        }
        for(var i = 0; i < TestColDiff.length; ++i){
          count=count+TestColDiff[i];
          groundcount=groundcount+180;
        }
        ongoingacc = 100*(1-(count/groundcount));
        // document.getElementById("acctext").innerHTML = 'Accuracy: ' + ongoingacc.toFixed(2) + '%';
      }
    }

    /* Always track mouse */
    let mouseX, mouseY;
    $(function() {
      $(document).bind('mousemove.overall', function(e) {
        mouseX = e.pageX;
        mouseY = e.pageY;
      });
    });

    /* Done with the experiment */
    function Done() {
      // calculate their overall accuracy (Practice + Test)
      count=0;groundcount=0;
      for(var i = 0; i < RepeatColDiff.length; ++i){
          count=count+RepeatColDiff[i];
          groundcount=groundcount+90;
      }
      for(var i = 0; i < PracticeColDiff.length; ++i){
          count=count+PracticeColDiff[i];
          groundcount=groundcount+90;
      }
      for(var i = 0; i < TestColDiff.length; ++i){
        count=count+TestColDiff[i];
        groundcount=groundcount+90;
      }
      OverallAcc = 1-(count/groundcount);
      let cashpoints = basepay + (OverallAcc*bonusmultiplier);
      if (cashpoints < basepay) { cashpoints = basepay; }
      cashpoints = cashpoints.toFixed(2);
      document.getElementById("cashPrize").innerHTML = "Total earnings ($" + basepay + " base pay + bonus): $" + cashpoints;
      document.getElementById("doneText").innerHTML = 'Thanks very much for your participation! Please wait 1-2 weeks for your bonus to process.<br><br>Please describe any strategy you used to better remember the images. (Also, do you have any general comments? Any technical difficulties?)<br><br>' +
        '<textarea name="comments" id="comments" style="width: 400px; height: 300px"></textarea><br><br>';
      $('#showTrial').hide();
      $('#done').show();
    }

    var Date_info = startDate.getMonth() + '_' + startDate.getDate() + '_' + startDate.getHours();

    /* What to save and put it on server */
    function SaveData() {
      $('#done').children().hide();
      $('#saving').show();
      $('#assignmentId').val(GetAssignmentId());
      const endDate = new Date().getTime();
      const d = {
        "ID": WORKERID,
        "ASSIGNMENTID": ASSIGNMENTID,
        "age": age,
        "sex": sex,
        "StartTime": startDate.getTime(),
        "EndTime": endDate,
        "PracticeColRT": PracticeColRT,
        "PracticeColResp": PracticeColResp,
        "PracticeColDiff": PracticeColDiff,
        "TestColRT": TestColRT,
        "TestColResp": TestColResp,
        "TestColDiff": TestColDiff,
        "CDType": CDType,
        "CDaccuracy": CDaccuracy,
        "AllImages": AllImages,
        "randrotate": randrotateList,
        "flip": flipList,
        "StudyTrials": StudyTrials,
        "PracticeTrials": PracticeTrials,
        "TestTrials": TestTrials,
        "numRepeats": numRepeats,
        "RepeatObj": RepeatObj,
        "RepeatCol": RepeatCol,
        "RepeatColResp": RepeatColResp,
        "RepeatColDiff": RepeatColDiff,
        "seed": chance1.seed,
        "bonus": (OverallAcc*bonusmultiplier).toFixed(2),
        "comments": $('#comments').val()
      };

      /* save to Firebase server */
      const blob = new Blob([JSON.stringify(d)], {
        type: "application/json"
      });
      const storageRef = firebase.storage().ref('Retrieval_MTurk_5/' + WORKERID + '.json');
      storageRef.put(blob);

      document.getElementById("saving").innerHTML = "Submitting...";

      /* submit after waiting a few seconds to make sure data got sent */
      setTimeout(function() {
        document.forms[0].submit();
      }, 3000);
    }

    /*check all images are loaded before starting*/
    function ImagesReady() {
      for (var i = 0; i < AllImages.length; i++) {
          // console.log(AllImages[i])
          if (!$('#Obj' + AllImages[i])[0].complete) {
              var percentage = i * 100.0 / (AllImages.length);
              percentage = percentage.toFixed(0).toString() + ' %';

              document.getElementById("loading").innerHTML =
                'Loading images ... ' + percentage + '<br>If more than a minute elapses, try refreshing page.';
              setTimeout('ImagesReady()', 20);
              return;
          }
      }
      $('#loading').hide();
      $('a#TextButton').show();
    };

    function start(context, deg, initX, initY, imgWidth, imgHeight, flip, image, itemID) {
        flip == 0 ? colors = origColors : colors = flippedColors;
        var col = [146.83, 146.83, 146.83]; // luminance-corrected gray
        if (deg != 'gray') {
            deg = (deg >= 360) ? deg - 360 : deg;
            deg = (deg < 0) ? deg + 360 : deg;
            col = colors[deg];
        }
        context.drawImage(image, initX, initY, imgWidth, imgHeight);
        recolor(context, Math.round(col[0]), Math.round(col[1]), Math.round(col[2]), initX, initY, itemID);
    }

    function recolor(context, newR, newG, newB, initX, initY, itemID) {
        imgData = context.getImageData(initX, initY, itemID.width, itemID.height);
        let data = imgData.data;
        for (let i = 0; i < data.length; i += 4) {
            let red = data[i];
            let green = data[i + 1];
            let blue = data[i + 2];
            if (red > 10 && blue < 250) {
                data[i] = newR;
                data[i + 1] = newG;
                data[i + 2] = newB;
            }
        }
        context.putImageData(imgData, initX, initY);
    }

    function wrapDiff(input, comparison) { // deg difference in color space
        if (input < comparison) {
            a = input;
            b = comparison
        } else {
            a = comparison;
            b = input
        }
        degree = Math.abs(a - b);
        if (degree > 180) {
            degree = Math.abs(a - (b - 360))
        }
        if (degree < -180) {
            degree = Math.abs(a - (b + 360))
        }
        return wrap(degree);
    }

    function arrayContains(needle, arrhaystack) {
      return arrhaystack.indexOf(needle);
    }

    /* running on IE? */
    function isIE() {
      ua = navigator.userAgent;
      var is_ie = ua.indexOf("MSIE ") > -1 || ua.indexOf("Trident/") > -1;
      return is_ie;
    }

    function bandwidth_test(){
      // Let's initialize the primitives
      var startedTime, endTime, fileSize;
      // Set up the AJAX to perform
      var xhr = new XMLHttpRequest();
      // Rig the call-back... THE important part
      xhr.onreadystatechange = function () {
        // we only need to know when the request has completed
        if (xhr.readyState === 4 && xhr.status === 200) {
          // Here we stop the timer & register end time
          endTime = (new Date()).getTime();
          // Also, calculate the file-size which has transferred
          fileSize = xhr.responseText.length;
          // Calculate band_speed as global variable; the connection-speed in kbps
          band_speed = (fileSize * 8) / ((endTime - startedTime)/1000) / 1024;
          if (band_speed < 3) {
            $('body').html('Unfortunately your internet speed is too slow for this experiment to operate as intended... Sorry!');
          }
        }
      }
      // Snap back; here's where we start the timer
      startedTime = (new Date()).getTime();
      // All set, let's hit it! Should be an image hosted by you, of small file size
      xhr.open("GET", "https://paulscotti.github.io/mturk/InterGroup_Spatial_files/objects/Object999.jpg", true);
      xhr.send();
    }

    $(function() { // check if Safari, IE, mobile, or slow internet
        if (!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/)) { // if Safari
            $('body').html('Unfortunately this HIT does not work in Safari. It works in Chrome only. Sorry!');
        } else if (isIE()) { // if IE
            $('body').html('Unfortunately this HIT does not work in Internet Explorer. It works in Chrome only. Sorry!');
        } else if (
            /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i
            .test(navigator.userAgent) ||
            /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i
            .test(navigator.userAgent.substr(0, 4))) {
            $('body').html('Unfortunately this HIT does not work on mobile devices. It works on desktop versions of Chrome only. Sorry!'); // dont allow mobile
        } else if (window.chrome !== null && typeof window.chrome !== "undefined" && window.navigator.vendor == "Google Inc."){
          bandwidth_test();
        } else {
          $('body').html('Unfortunately this HIT only works on desktop versions of Chrome. If this is a mistake and you are using Chrome, try updating your browser. Sorry!');
        }
    });

    function requestFullScreen() {

      var el = document.body;

      // Supports most browsers and their versions.
      var requestMethod = el.requestFullScreen || el.webkitRequestFullScreen ||
        el.mozRequestFullScreen || el.msRequestFullScreen;

      if (requestMethod) {

        // Native full screen.
        requestMethod.call(el);

      } else if (typeof window.ActiveXObject !== "undefined") {

        // Older IE.
        var wscript = new ActiveXObject("WScript.Shell");

        if (wscript !== null) {
          wscript.SendKeys("{F11}");
        }
      }
    }

    function modalContinue() {
      modalClosed = true;
    }

    function checkFlag5() {
      if (modalClosed == false) {
        window.setTimeout(checkFlag5, 100); /* this checks the flag every 100 milliseconds*/
      } else {
        $('#SameButton').hide();
        $('#DiffButton').hide();
        curCD++;
        ChangeDetection()
      }
    }
  </script>
</body>

</html>
