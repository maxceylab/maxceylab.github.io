<!-- Paul Scotti 2019 -->
<!-- Set code as .html file -->
<html>

<!-- Preload javascript and css files -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
  <script src="https://maxceylab.github.io/expts/js_code/jquery.min.js"></script>
  <script src="https://maxceylab.github.io/expts/js_code/seedrandom.js"></script>
  <script src="https://maxceylab.github.io/expts/js_code/chance.js"></script>
  <script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/TimTurkTools.js"></script>
  <script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/jcanvas.min.js"></script>
  <script>
  let WORKERID = (IsOnTurk()) ? GetWorkerId() : prompt("You don't look like an mTurker! " +
      "Enter an ID to save your data with (any number/string will do). Note your id is used to seed the experiment rng:", "workID");
  let ASSIGNMENTID = (IsOnTurk()) ? GetAssignmentId() : prompt("Set assignment number (doesnt matter for testing):", "assignmentId");
  const startDate = new Date(); const chance1 = Chance(WORKERID); Math.seedrandom(chance1.seed); // Use current workerid as the shuffle seed, so you can trace back their trials</script>
  <script src="https://maxceylab.github.io/expts/js_code/lodash.core.js">// Allows _clone</script>

  <!-- Preload images -->
  <script src="https://maxceylab.github.io/expts/retrieval/loadimg.js"></script>
  <script src="https://maxceylab.github.io/expts/retrieval/initVariables.js"> </script>

  <!-- load Firebase server javascript, we are using it for storage -->
  <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>

  <link rel="stylesheet" type="text/css" href="https://maxceylab.github.io/expts/retrieval/contReport.css">
  <link rel="stylesheet" type="text/css" href="https://maxceylab.github.io/expts/retrieval/showTrials.css">
  <link rel="stylesheet" type="text/css" href="https://maxceylab.github.io/expts/retrieval/experiment.css">

</head>

<body>
  <!-- Instructions page1 -->
  <div id="instructions">
    <center>
        <p>This experiment is a memorization task involving visual images. It will take approximately 1 hour to complete.</p>
      </center>
    <p style="text-align: center"><a href="javascript:void(0)" onclick="$('#instructions').hide();$('#instructions2').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton">Next (1 of 5)</a></p>
  </div>

  <!-- Instructions page2 -->
  <div id="instructions2" style="display:none">
    <center>
        <p>You will be presented with 48 objects, one at a time, each presented for 3 seconds. Each object will repeat three times during this study phase.</p>
        <p>Example of an object:</p>

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval1.png" width="600px"></p>

        <p>The task is to study the color and identity of each object for a later memory test.</p>
      </center>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions2').hide();$('#instructions3').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton">Next (2 of 5)</a></p>
  </div>

  <!-- Instructions page3 -->
  <div id="instructions3" style="display:none">
    <center>
        <p>Studied objects will often be similar to each other. For instance, you may encounter several different types of bowties.</p>

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval2.png" width="600px"></p>
        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval3.png" width="600px"></p>

        <p>It is therefore not sufficient to remember "purple bowtie". Your memory will need to be as precise as "striped purple bowtie".</p>
        <p>After you have studied all the objects, we will test your memory.</p>
      </center>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions3').hide();$('#instructions4').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton">Next (3 of 5)</a></p>
  </div>

  <!-- Instructions page4 -->
  <div id="instructions4" style="display:none">
    <center>
        <p><u>There are two possible ways we may test your memory, randomly selected on every test trial.</u></p>

        <p><h2>1. Recognition Test:</h2></p>

        <p>On <i>Recognition</i> test trials, a colored object is presented with two buttons beneath, "Old" and "New". For example:</p>

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval4.png" width="600px"></p>

        <p>If you have seen the object before (i.e., it was one of the 48 objects that you previously studied), then click the "Old" button. In this case, you previously saw this bowtie so you would click "Old".</p>

        <p>If you have never seen the object before, then click the "New" button.</p>

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval5.png" width="600px"></p>

        <p>Since you have not seen the above bowtie before, you'd click the "New" button.</p>

        <p><b>We will never trick you by presenting a previously seen object in the incorrect color.</b> E.g., we would never present a yellow polkadot bowtie.</p>
      </center>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions4').hide();$('#instructions5').show();document.body.scrollTop = document.documentElement.scrollTop = 0;$('a#TextButton').hide();ImagesReady();" id="TextButton">Next (4 of 5)</a></p>
  </div>

  <!-- Instructions page5 -->
  <div id="instructions5" style="display:none">
    <center>
        <p><h2>2. Color Test:</h2></p>

        On <i>Color</i> test trials, an object is presented in <u>grayscale</u> with two buttons beneath, "Old" and "New". For example:

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval6.png" width="600px"></p>

        <p>Just like the <i>Recognition</i> test trials, if you have seen the object before, click the "Old" button. Otherwise, click the "New" button.</p>

        <p>In this case, since you have seen the above object before, you would click the "Old" button (even though it is not presented in its original color).</p>

        <p>After clicking one of the buttons, a color wheel will be presented. Move your mouse around the color wheel to change the color of the displayed object. Find the original color of the object and then click using your mouse to confirm your selection.</p>

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/retrieval7.png" width="600px"></p>

        <p>If you are unsure of the original color, move your mouse around and click what feels right. Please be as precise as possible in selecting what you think is the object's original color.</p>

        <p><b>Even if you select "New", you will still need to select a color.</b> This means that you will sometimes be asked to select the color of an object you have never seen before! When this happens, you can make a random selection on the color wheel to continue. We do this because it is possible you think the object is "New" when it was actually "Old", in which case the color you provide could still be correct.</p>

        <hr>

        <p><b>The more accurate your responses, the more bonus money you will receive at the end of the HIT (up to $3.00).</b></p>

        <p>Ready to start? You will begin by memorizing a series of colored objects.</p>

        <p><i>Please set aside approximately 1 hour to complete this experiment. Please do your best -- the amount of time we will spend analyzing your data far exceeds 1 hour!</i></p>
      </center>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions4').hide();document.body.scrollTop = document.documentElement.scrollTop = 0;StartExperiment();" id="TextButton">Start Experiment</a></p>
    <center><p id=loading>Images loading... Please wait a minute or refresh the page.</p></center>
  </div>

  <!-- $('a#TextButton').hide();ImagesReady(); -->

  <!-- Modal Pop-up Box -->
  <div id="openModal" class="modalDialog">
    <div>
      <a href="#close" onclick="modalContinue();" title="Close" class="close">X</a>
      <p id="openModal_text">Hi!</p>
    </div>
  </div>

  <!-- Screen after submitting expt -->
  <div id="done">
    <center>
    <div id="cashPrize">text</div>
    </center>
    <div id="doneText">
    </div>
    <div>
      <center>
        <a href="javascript:void(0);" onclick="SaveData()" id="submitForm">Click to Submit</a>
      </center>
    </div>
  </div>
  <div id="saving">Saving . . .</div>
  </div>

  <!-- Display Object HTML -->
  <div id="showTrial">
    <div id="fixation">+</div>
    <div id="allItems">
      <canvas id="itemA" width=300 height=300 style="position:absolute; top:150px; left:150px;"></canvas>
      <img id="CDitem" src="https://maxceylab.github.io/stimuli/change_detection/CDfix.png" width=600 height=600></img>
    </div>
    <canvas id="ringItemA" width=600 height=600 style="position: absolute;"></canvas>
    <div id="pointer"></div>
    <br><br>
    <center>
      <a href="javascript:void(0);" onclick="Old();" id="Old" style="display: hidden;">Old</a>
      <a href="javascript:void(0);" onclick="New();" id="New" style="display: hidden;">New</a>
      <a href="javascript:void(0);" onclick="SamePress();" id="SameButton" style="display: hidden;">Same</a>
      <a href="javascript:void(0);" onclick="DiffPress();" id="DiffButton" style="display: hidden;">Different</a>
    </center>
  </div>

  <!-- Initializing JS -->
  <script>
    /* Initialize Firebase */
    const config = {
      apiKey: "AIzaSyB4FT9tacVGSKmDyWf203wy7WeiDYCDEFM",
      authDomain: "maxceylab-25a85.firebaseapp.com",
      databaseURL: "https://maxceylab-25a85.firebaseio.com",
      projectId: "maxceylab-25a85",
      storageBucket: "maxceylab-25a85.appspot.com",
      messagingSenderId: "521427523696"
    };
    firebase.initializeApp(config);

    /* Disable context/right-click menu */
    // document.oncontextmenu = function() {
    //     return false;
    // }

    /* Define more variables */
    let modalClosed = false;
    const numStudy = 96*3;
    const numPractice = 96;
    const numTest = 192;
    const displayTime = 3000; //3000 ms
    const itiTime = 500; // 500 ms
    const imgWidth = 300;
    const imgHeight = 300;
    </script>
    <script src="https://maxceylab.github.io/expts/retrieval/colors_blocked.js"> </script>
    <script>
    let curStudy = 0;
    let curPractice = 0;
    let curTest = 0;
    let RpPlusCnt = 0;
    let RpMinusCnt = 0;
    let NrpCnt = 0;
    let PracLuresCnt = 0;
    let RpTestLuresCnt = 0;
    let NrpTestLuresCnt = 0;
    let RpPlusRCnt = 0;
    let RpMinusRCnt = 0;
    let NrpRCnt = 0;
    let PracLuresRCnt = 0;
    let RpTestLuresRCnt = 0;
    let NrpTestLuresRCnt = 0;
    let now = new Date().getTime(); // used for 5 min filler task
    let now2 = now;
    let curCD = 0;
    let CDaccuracy = [];
    let CDType = [];
    let PracticeResp = [];
    let PracticeAcc = [];
    let PracticeRT = [];
    let PracticeColRT = [];
    let PracticeColResp = [];
    let PracColOriginal = [];
    let TestResp = [];
    let TestAcc = [];
    let TestRT = [];
    let TestColRT = [];
    let TestColResp = [];
    let TestColOriginal = [];
    let RepeatColResp = [];
    let flip = 0;
    let flipList = [0];
    let PracTypeList = [];
    let TestTypeList = [];
    let randrotate = 0;
    let randrotateList = [];
    const origColors = _.clone(colors); // clone is required to copy a variable without it accidentally referencing the same thing
    let flippedColors = _.clone(colors).reverse();
    flippedColors = flippedColors.concat(flippedColors.splice(0, 180)); // shift array 180
    let tempVar = true;
    let startingColor = -999;
    let mouseMoved = 0;
    let angleDeg = -999;
    const radius = 242;
    const ringSize = 242;
    const centerX = 300;
    const centerY = 300;
    let PracTestedImage = [];
    let TestedImage = [];
    let basepay = 4;
    let numRepeats = 0;
    let RepeatObj = [];
    let OrigStudyColors = [];
    locked = 0;

    /* Setup reused image and color ring variables */
    let ringStandard = new Image();
    ringStandard.crossOrigin = "anonymous";
    ringStandard.src = $('#ring')[0].src;
    let ringFlipped = new Image();
    ringFlipped.crossOrigin = "anonymous";
    ringFlipped.src = $('#ringFlip')[0].src;

    /* Setup CD images */
    let imgCD = new Image();
    imgCD.crossOrigin = "anonymous";
    imgCD.src = $('#diff1')[0].src;
    let CDfix = new Image();
    CDfix.crossOrigin = "anonymous";
    CDfix.src = $('#CDfix')[0].src;
    let imgCDtest = new Image();
    imgCDtest.crossOrigin = "anonymous";
    imgCDtest.src = $('#diff1t')[0].src;

    /* Setting up canvas contexts */
    const itemA = document.getElementById("itemA");
    const ctxA = itemA.getContext("2d");
    const ringItemA = document.getElementById("ringItemA");
    const ringctxA = ringItemA.getContext("2d");
    /* Set up non-canvas contexts */
    const CDitem = document.getElementById("CDitem");

    /* Start Experiment */
    function StartExperiment() {
      if (IsOnTurk() && IsTurkPreview()) {
          alert("Please accept the HIT before continuing.");
          return false;
      }

      // save a file letting me know that someone made it this far
      const blobx = new Blob([JSON.stringify(chance1.seed)], {
        type: "application/json"
      });
      const storageRefx = firebase.storage().ref('started_retrieval/' + WORKERID + '.json');
      storageRefx.put(blobx);

      age = prompt('Before we start, can you tell me how old you are (in years)?');

      while (age > 100 || age < 18 || !(age>=18)) {
        age = prompt('Can you tell me how old you are (e.g., 18, not the year you were born)?');
      }

      if (age > 45) {
        $('body').html('<center><b>Unfortunately, this experiment does not allow participants over 45 years old (we separately study older populations).<br><br>Please return this HIT.<br><br>You will not be paid if you try again and change your age.</b></center>');
      }

      sex = prompt('And are you male (M), female (F), non-binary (B), or prefer not to answer (NA)?');

      while (!(sex == 'M' || sex == 'F' || sex == 'B' || sex == 'NA' || sex == 'm' || sex == 'f' || sex == 'b' || sex == 'na' || sex == 'female' || sex == 'male' || sex == 'Female' || sex == 'Male')) {
        sex = prompt('Are you male (M), female (F), non-binary (B), or prefer not to answer (NA)? Type one of the options shown in parentheses.');
      }
      if (sex == 'M' || sex == 'm' || sex == 'male' || sex == 'Male') {
        sex = 'm';
      } else if (sex == 'F' || sex == 'f' || sex == 'female' || sex == 'Female') {
        sex = 'f';
      } else if (sex == 'B' || sex == 'b') {
        sex = 'b';
      } else if (sex == 'NA' || sex == 'na') {
        sex = 'na';
      }

      // initials = prompt('What are your initials (e.g., John Smith would be "JS")?');
      // subjID = initials + '_' + startDate.getMonth() + '_' + startDate.getDate() + '_' + startDate.getHours();

      $('#instructions5').hide();
      $('#pointer').hide();
      $('#ringItemA').hide();

      // // save a file letting me know that someone made it this far
      // const blobx = new Blob([JSON.stringify(chance1.seed)], {
      //   type: "application/json"
      // });
      // const storageRefx = firebase.storage().ref('started/' + subjID + '.json');
      // storageRefx.put(blobx);

      // open pop-up:
      modalClosed = false;
      document.getElementById("openModal_text").innerHTML = 'Experiment will now begin. Good luck!';
      window.location.href = '#openModal';
      checkFlag1();

      function checkFlag1() {
        if (modalClosed == false) {
          window.setTimeout(checkFlag1, 100); /* this checks the flag every 100 milliseconds*/
        } else {
          $('#showTrial').show();
          NextStudyTrial();
        }
      }

    }

    /* Study Phase Start */
    function NextStudyTrial() {
      if (curStudy >= numStudy) { // if end of study
        curStudy++;
        locked=0;
        $('#pointer').css('margin-top', 0);

        now = new Date().getTime();
        now2 = now;
        $('#itemA').hide(); // hide object from last trial
        $('#Old').hide(); // hide Old button
        $('#New').hide(); // hide New button

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'End of Study Phase! <br><br> Before we test your memory for the studied objects, we will do a short task. <br><br> You will see an array of colored squares appear for a brief moment. Then, one colored square will be presented. The task is to select whether the colored square is the same color or a different color than it was before.';
        window.location.href = '#openModal';
        checkFlag2();
        return;

        function checkFlag2() {
          if (modalClosed == false) {
            window.setTimeout(checkFlag2, 100); /* this checks the flag every 100 milliseconds*/
          } else {
            RpPlusCnt = 0; //reset counter for RpPlus
            ChangeDetection(); // start Practice Phase
            return; // need return; otherwise the ShowTrial below executes
          }
        }
      } else {
        // Preload the image of next trial
        if (curStudy > 0) { curDicPast = curDic; }
        if (StudyTrialType[curStudy] == 0) { //RpPlus
          curDicX = RpPlus[RpPlusCnt];
          curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
          start(ctxA, RpPlusC[RpPlusCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          OrigStudyColors.push(RpPlusC[RpPlusCnt]);
          RpPlusCnt++;
          if (RpPlusCnt >= RpPlus.length) {
            RpPlusCnt=0;
          } // prevent problems if on last trial of condition
        } else if (StudyTrialType[curStudy] == 1) { //RpMinus
          curDicX = RpMinus[RpMinusCnt];
          curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
          start(ctxA, RpMinusC[RpMinusCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          OrigStudyColors.push(RpMinusC[RpMinusCnt]);
            RpMinusCnt++;
            if (RpMinusCnt >= RpMinus.length) {
              RpMinusCnt=0;
            }
        } else if (StudyTrialType[curStudy] == 2) { //Nrp
          curDicX = Nrp[NrpCnt];
          curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
          start(ctxA, NrpC[NrpCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          OrigStudyColors.push(NrpC[NrpCnt]);
            NrpCnt++;
            if (NrpCnt >= Nrp.length) {
              NrpCnt=0;
            }
        } else if (StudyTrialType[curStudy] == 10) { //RpPlusR
          curDicX = RpPlusR[RpPlusRCnt];
          curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
          start(ctxA, RpPlusRC[RpPlusRCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          OrigStudyColors.push(RpPlusRC[RpPlusRCnt]);
            RpPlusRCnt++;
            if (RpPlusRCnt >= RpPlusRC.length) {
              RpPlusRCnt=0;
            }
        } else if (StudyTrialType[curStudy] == 11) { //RpMinusR
          curDicX = RpMinusR[RpMinusRCnt];
          curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
          start(ctxA, RpMinusRC[RpMinusRCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          OrigStudyColors.push(RpMinusRC[RpMinusRCnt]);
            RpMinusRCnt++;
            if (RpMinusRCnt >= RpMinusRC.length) {
              RpMinusRCnt=0;
            }
        } else if (StudyTrialType[curStudy] == 12) { //NrpR
          curDicX = NrpR[NrpRCnt];
          curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
          start(ctxA, NrpRC[NrpRCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          OrigStudyColors.push(NrpRC[NrpRCnt]);
            NrpRCnt++;
            if (NrpRCnt >= NrpRC.length) {
              NrpRCnt=0;
            }
        }
      }

      setTimeout(function() {
        ShowStudy();
      }, itiTime/2); // wait a tad just to ensure image got switch
    }

    /* Display Object */
    function ShowStudy() {
      $('#allItems').css('margin-top', 0);
      setTimeout(function() {
        $('#allItems').css('margin-top', -1000);
        setTimeout(function() {
          if (Repeats.includes(curStudy) && locked==0) {
            locked=1;
            numRepeats = numRepeats+1;
            start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, imageDic[curDicPast], itemA);
            RepeatObj.push(imageDic[curDicPast]);
            $('#allItems').css('margin-top', 0);
            $('#pointer').css('margin-top', 0);
            // open pop-up:
            modalClosed = false;
            document.getElementById("openModal_text").innerHTML =
              'Sometimes we will interrupt to gauge your attention. The object from two presentations prior will now appear in grayscale and your task is to click its original color.';
            window.location.href = '#openModal';
            checkFlagCont();

            function checkFlagCont() {
              if (modalClosed == false) {
                window.setTimeout(checkFlagCont, 100); /* this checks the flag every 100 milliseconds*/
              } else {
                Continuous();
              }
            }
          } else {
            locked=0;
            curStudy++;
            NextStudyTrial();
          }
        }, itiTime/2); // fulfill rest of itiTime before showing study image
      }, displayTime);
    }

    /* Practice Phase Start */
    function NextPracTrial() {
      $(document).unbind('mousemove.curTrial');
      $(document).unbind('mouseup.curTrial');
      $('#allItems').css('margin-top', -1000);
      // Preload the image of next trial
      if (PracTrialType[curPractice] == 0) { //RpPlus
        curDicX = RpPlusPrac[RpPlusCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        start(ctxA, RpPlusC[arrayContains(imageDic[curDic].id,RpPlus)], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        setTimeout(function() {
          start(ctxA, RpPlusC[arrayContains(imageDic[curDic].id,RpPlus)], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          PracColOriginal.push(RpPlusC[arrayContains(imageDic[curDic].id,RpPlus)]);
          if (RpPlusCnt <= RpPlus.length*2) {
            RpPlusCnt++;
          }
        }, itiTime/2);
      } else if (PracTrialType[curPractice] == 3) { //PracLure
        curDicX = PracLures[PracLuresCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        start(ctxA, PracLuresC[PracLuresCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        setTimeout(function() {
          start(ctxA, PracLuresC[PracLuresCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          PracColOriginal.push(PracLuresC[PracLuresCnt]);
          if (PracLuresCnt <= PracLures.length) {
            PracLuresCnt++;
          }
        }, itiTime/2);
      } else if (PracTrialType[curPractice] == 10) { //RpPlusR
        // RpPlusRC[arrayContains(RpPlusPracR[RpPlusRCnt],RpPlusR)]
        curDicX = RpPlusPracR[RpPlusRCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        PracColOriginal.push(RpPlusRC[arrayContains(imageDic[curDic].id,RpPlusR)]);
        start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        if (RpPlusRCnt <= RpPlus.length*2) {
          RpPlusRCnt++;
        }
      } else if (PracTrialType[curPractice] == 13) { //PracLureR
        // PracLuresRC[PracLuresRCnt]
        PracColOriginal.push(PracLuresRC[PracLuresRCnt]);
        curDicX = PracLuresR[PracLuresRCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        if (PracLuresRCnt <= PracLures.length) {
          PracLuresRCnt++;
        }
      }
      console.log('---p');
      console.log(curPractice);
      console.log(PracTrialType[curPractice]);
      console.log(imageDic[curDic]);

      PracTestedImage.push(imageDic[curDic].id);

      setTimeout(function() {
        if (PracTrialType[curPractice] > 9) {
          start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, flip, imageDic[curDic], itemA);
        }
      }, itiTime+5); // wait a little bit just to make sure image got switched in time

      setTimeout(function() {
        if (curPractice >= numPractice) { // if end of practice
          curPractice++;

          now = new Date().getTime();
          now2 = now;
          $('#itemA').hide(); // hide object from last trial
          $('#Old').hide(); // hide Old button
          $('#New').hide(); // hide New button

          // open pop-up:
          modalClosed = false;
          document.getElementById("openModal_text").innerHTML =
            'Good work so far! <br> We will continue to test your memory after some more change detection trials.';
          window.location.href = '#openModal';
          checkFlag3();
          return;

          function checkFlag3() {
            if (modalClosed == false) {
              window.setTimeout(checkFlag3, 100); /* this checks the flag every 100 milliseconds*/
            } else {
              ChangeDetection(); // start filler task
              return; // need return; otherwise function below executes
            }
          }
        }
        OldNewJudgment();
      }, itiTime);
    }

    function Continuous() {
      $('#ringItemA').show();
      $('#CDitem').hide();
      $('#Old').hide();
      $('#New').hide();

      flip == 0 ? ringctxA.drawImage(ringStandard, 50, 50, 500, 500) : ringctxA.drawImage(ringFlipped, 50, 50, 500, 500);

      mouseInit = mouseX;
      imgNum = -999;
      mouseMoved = 0;
      angleDeg = 0;
      startTimeC = new Date();

      $(document).bind('mousemove.curTrial', function(e) {
        parentOffset = $('#showTrial').offset();
        relX = e.pageX - parentOffset.left - centerX;
        relY = e.pageY - parentOffset.top - centerY;
        curAngle = Math.atan2(relY, relX);
        angleDeg = curAngle / Math.PI * 180.0;
        if (mouseMoved == 0) {
            if (mouseInit != mouseX) {
                setTimeout(function() {
                    imgNum = Math.round(wrap([angleDeg - randrotate]));
                    startingColor = imgNum;
                    mouseMoved = 1;
                    // start(ctxA, imgNum, 0, 0, imgWidth, imgHeight, flip, imageDic[curDic], itemA);
                }, 400);
            }
        } else {
            imgNum = Math.round(wrap([angleDeg - randrotate]));
            // start(ctxA, imgNum, 0, 0, imgWidth, imgHeight, flip, imageDic[curDic], itemA);
        }
        $('#pointer').css({
            'left': centerX + Math.cos(curAngle) * ringSize - 9,
            'top': centerY + Math.sin(curAngle) * ringSize - 9
        });
        $('#pointer').show();
      });
      $(document).bind('mouseup.curTrial', function(e) {
        if (new Date() - startTimeC > 750) {
          $('#ringItemA').hide();
          $('#pointer').hide();
          if (locked==1) {
            curStudy++;
            // Preload the image of next trial
            if (StudyTrialType[curStudy] == 0) { //RpPlus
              curDicX = RpPlus[RpPlusCnt];
              curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
              start(ctxA, RpPlusC[RpPlusCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
              RpPlusCnt++;
              if (RpPlusCnt >= RpPlus.length) {
                RpPlusCnt=0;
              } // prevent problems if on last trial of condition
            } else if (StudyTrialType[curStudy] == 1) { //RpMinus
              curDicX = RpMinus[RpMinusCnt];
              curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
              start(ctxA, RpMinusC[RpMinusCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
                RpMinusCnt++;
                if (RpMinusCnt >= RpMinus.length) {
                  RpMinusCnt=0;
                }
            } else if (StudyTrialType[curStudy] == 2) { //Nrp
              curDicX = Nrp[NrpCnt];
              curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
              start(ctxA, NrpC[NrpCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
                NrpCnt++;
                if (NrpCnt >= Nrp.length) {
                  NrpCnt=0;
                }
            } else if (StudyTrialType[curStudy] == 10) { //RpPlusR
              curDicX = RpPlusR[RpPlusRCnt];
              curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
              start(ctxA, RpPlusRC[RpPlusRCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
                RpPlusRCnt++;
                if (RpPlusRCnt >= RpPlusRC.length) {
                  RpPlusRCnt=0;
                }
            } else if (StudyTrialType[curStudy] == 11) { //RpMinusR
              curDicX = RpMinusR[RpMinusRCnt];
              curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
              start(ctxA, RpMinusRC[RpMinusRCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
                RpMinusRCnt++;
                if (RpMinusRCnt >= RpMinusRC.length) {
                  RpMinusRCnt=0;
                }
            } else if (StudyTrialType[curStudy] == 12) { //NrpR
              curDicX = NrpR[NrpRCnt];
              curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
              start(ctxA, NrpRC[NrpRCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
                NrpRCnt++;
                if (NrpRCnt >= NrpRC.length) {
                  NrpRCnt=0;
                }
            }
            $(document).unbind('mousemove.curTrial');
            $(document).unbind('mouseup.curTrial');
            $('#pointer').css('margin-top', -1000);
            $('#allItems').css('margin-top', -1000);
            RepeatColResp.push(wrap(imgNum));
            if (flip == 1) {
              a = origColors[arrayContains(flippedColors[wrap(imgNum)],origColors)];
              imgNum = origColors.findIndex(k => k==a);
            }
            if (wrapDiff(imgNum,OrigStudyColors[OrigStudyColors.length-2]) <= 30) {
              alert('You were ' + wrapDiff(imgNum,OrigStudyColors[OrigStudyColors.length-2]) + ' degrees away. Great!')
            } else {
              alert('You were ' + wrapDiff(imgNum,OrigStudyColors[OrigStudyColors.length-2]) + ' degrees away. Not quite...')
            }
            setTimeout(function() {
              $('#Old').hide(); // hide Old button
              $('#New').hide(); // hide New button
              locked=0;
              NextStudyTrial();
              return;
            }, itiTime);
          }
          if (curPractice > numPractice && locked==0) { // if test phase
            TestColRT.push(new Date() - startTimeC);
            if (flip == 1) {
              a = origColors[arrayContains(flippedColors[wrap(imgNum)],origColors)];
              imgNum = origColors.findIndex(k => k==a);
            }
            TestColResp.push(wrap(imgNum));
            TestTypeList.push(TestTrialType[curTest]);
            curTest++;
            NextTestTrial();
          } else if (locked==0) { // if practice phase
            PracticeColRT.push(new Date() - startTimeC);
            if (flip == 1) {
              a = origColors[arrayContains(flippedColors[wrap(imgNum)],origColors)];
              imgNum = origColors.findIndex(k => k==a);
            }
            PracticeColResp.push(wrap(imgNum));
            PracTypeList.push(PracTypeList[curPractice]);
            curPractice++;
            NextPracTrial();
          }
          return;
        };
      });
    }

    /* Display Object & Old/New Judgment */
    function OldNewJudgment() {
      startTrial = new Date().getTime();
      $('#CDitem').show();
      $('#Old').show();
      $('#New').show();
      $('#allItems').css('margin-top', 0);
    }

    /* Filler Start */
    function ChangeDetection() {
      $('#allItems').css('margin-top', 0);
      $('#CDitem').show();
      if (now2 < (now + 180000)) { // 180000 for 3 minutes long filler task
        ChangeDetectionTrial();
      } else {
        $('#CDitem').attr('src', CDfix.src); // reset last CD trial to CDfix; make sure all components of CD task are hidden before moving on
        $('#SameButton').hide();
        $('#DiffButton').hide();
        $('#allItems').css('margin-top', -1000); // show object items again and hide them off-screen
        $('#itemA').show();

        RpPlus_StudyOrder = RpPlus;
        RpPlusCnt = 0; //reset counter for RpPlus
        RpPlusT = chance1.shuffle(RpPlus); //reshuffle ordering of RpPlus
        RpMinus_StudyOrder = RpMinus;
        RpMinusCnt = 0;
        RpMinusT = chance1.shuffle(RpMinus);
        Nrp_StudyOrder = Nrp;
        NrpCnt = 0;
        NrpT = chance1.shuffle(Nrp);

        RpPlusR_StudyOrder = RpPlusR;
        RpPlusRCnt = 0; //reset counter for RpPlus
        RpPlusRT = chance1.shuffle(RpPlusR); //reshuffle ordering of RpPlus
        RpMinusR_StudyOrder = RpMinusR;
        RpMinusRCnt = 0;
        RpMinusRT = chance1.shuffle(RpMinusR);
        NrpR_StudyOrder = NrpR;
        NrpRCnt = 0;
        NrpRT = chance1.shuffle(NrpR);

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'Great job! <br><br> We will now test your memory for the initial study images. <br><br> You will see objects one at a time and be asked if you have seen the object before. If so, press the <i>old</i> button. If you have not seen the image before, press the <i>new</i> button.';
        window.location.href = '#openModal';
        checkFlag6();

        function checkFlag6() {
          if (modalClosed == false) {
            window.setTimeout(checkFlag6, 100); /* this checks the flag every 100 milliseconds*/
          } else if (curPractice > numPractice) {
            NextTestTrial();
          } else {
            NextPracTrial();
          }
        }
      }
    }

    // Present CD trial
    function ChangeDetectionTrial() {
      now2 = new Date().getTime();

      if ([0].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // same
        imgCD.src = $('#same' + (curCD % 25 + 1))[0].src; // memory array
        imgCDtest.src = $('#same' + (curCD % 25 + 1) + 't')[0].src; // test array
        CDType.push(0); // record what type of CD trial this was
      } else { //diff
        imgCD.src = $('#diff' + (curCD % 25 + 1))[0].src;
        imgCDtest.src = $('#diff' + (curCD % 25 + 1) + 't')[0].src;
        CDType.push(1);
      }

      $('#CDitem').attr('src', CDfix.src);
      setTimeout(function() { // after 800 ms, show colored memory array
        $('#CDitem').attr('src', imgCD.src);
        setTimeout(function() { // after 500 ms, show fixation again
          $('#CDitem').attr('src', CDfix.src);
          setTimeout(function() { // after 900 ms, show test array
            $('#CDitem').attr('src', imgCDtest.src);
            $('#SameButton').show();
            $('#DiffButton').show();
          }, 900);
        }, 500);
      }, 800);
    }

    // Responses for Change Detection
    function SamePress() {
      if ([0].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // same
        CDaccuracy.push(1);

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'Correct! Keep going!';
        window.location.href = '#openModal';

        checkFlag5();

      } else if ([1].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // diff
        CDaccuracy.push(0);

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'Incorrect...';
        window.location.href = '#openModal';

        checkFlag5();
      }
    }

    function DiffPress() {
      if ([1].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // diff
        CDaccuracy.push(1);

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'Correct! Keep going!';
        window.location.href = '#openModal';

        checkFlag5();
      } else if ([0].includes(parseInt(CDSet[curCD].slice(0, 2)))) { // same
        CDaccuracy.push(0);

        // open pop-up:
        modalClosed = false;
        document.getElementById("openModal_text").innerHTML =
          'Incorrect...';
        window.location.href = '#openModal';

        checkFlag5();
      }
    }

    /* Test Phase Start */
    function NextTestTrial() {
      $(document).unbind('mousemove.curTrial');
      $(document).unbind('mouseup.curTrial');
      $('#allItems').css('margin-top', -1000);
      // Preload the image of next trial
      if (TestTrialType[curTest] == 0) { //RpPlus
        curDicX = RpPlusT[RpPlusCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        start(ctxA, RpPlusC[arrayContains(imageDic[curDic].id,RpPlus)], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        setTimeout(function() {
          start(ctxA, RpPlusC[arrayContains(imageDic[curDic].id,RpPlus)], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          TestColOriginal.push(RpPlusC[arrayContains(imageDic[curDic].id,RpPlus)]);
          if (RpPlusCnt <= RpPlus.length) {
            RpPlusCnt++;
          }
        }, itiTime/2);
      } else if (TestTrialType[curTest] == 1) { //RpMinus
        curDicX = RpMinusT[RpMinusCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        start(ctxA, RpMinusC[arrayContains(imageDic[curDic].id,RpMinus)], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        setTimeout(function() {
          start(ctxA, RpMinusC[arrayContains(imageDic[curDic].id,RpMinus)], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          TestColOriginal.push(RpMinusC[arrayContains(imageDic[curDic].id,RpMinus)]);
          if (RpMinusCnt <= RpMinus.length) {
            RpMinusCnt++;
          }
        }, itiTime/2);
      } else if (TestTrialType[curTest] == 2) { //Nrp
        curDicX = NrpT[NrpCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        start(ctxA, NrpC[arrayContains(imageDic[curDic].id,Nrp)], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        setTimeout(function() {
          start(ctxA, NrpC[arrayContains(imageDic[curDic].id,Nrp)], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          TestColOriginal.push(NrpC[arrayContains(imageDic[curDic].id,Nrp)]);
          if (NrpCnt <= Nrp.length) {
            NrpCnt++;
          }
        }, itiTime/2);
      } else if (TestTrialType[curTest] == 4) { //RpTestLures
        curDicX = RpTestLures[RpTestLuresCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        start(ctxA, RpTestLuresC[RpTestLuresCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        setTimeout(function() {
          start(ctxA, RpTestLuresC[RpTestLuresCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          TestColOriginal.push(RpTestLuresC[RpTestLuresCnt]);
          if (RpTestLuresCnt <= RpTestLures.length) {
            RpTestLuresCnt++;
          }
        }, itiTime/2);
      } else if (TestTrialType[curTest] == 5) { //NrpTestLures
        curDicX = NrpTestLures[NrpTestLuresCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        start(ctxA, NrpTestLuresC[NrpTestLuresCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        setTimeout(function() {
          start(ctxA, NrpTestLuresC[NrpTestLuresCnt], 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
          TestColOriginal.push(NrpTestLuresC[NrpTestLuresCnt]);
          if (NrpTestLuresCnt <= NrpTestLures.length) {
            NrpTestLuresCnt++;
          }
        }, itiTime/2);
      } else if (TestTrialType[curTest] == 10) { //RpPlusR
        curDicX = RpPlusRT[RpPlusRCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        TestColOriginal.push(RpPlusRC[arrayContains(imageDic[curDic].id,RpPlusR)]);
        start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        if (RpPlusRCnt <= RpPlus.length) {
          RpPlusRCnt++;
        }
      } else if (TestTrialType[curTest] == 11) { //RpMinusR
        curDicX = RpMinusRT[RpMinusRCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        TestColOriginal.push(RpMinusRC[arrayContains(imageDic[curDic].id,RpMinusR)]);
        start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        if (RpMinusRCnt <= RpMinus.length) {
          RpMinusRCnt++;
        }
      } else if (TestTrialType[curTest] == 12) { //NrpR
        curDicX = NrpRT[NrpRCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        TestColOriginal.push(NrpC[arrayContains(imageDic[curDic].id,NrpR)]);
        start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        if (NrpRCnt <= Nrp.length) {
          NrpRCnt++;
        }
      } else if (TestTrialType[curTest] == 14) { //RpTestLuresR
        curDicX = RpTestLuresR[RpTestLuresRCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        TestColOriginal.push(RpTestLuresRC[RpTestLuresRCnt]);
        start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        if (RpTestLuresRCnt <= RpTestLures.length) {
          RpTestLuresRCnt++;
        }
      } else if (TestTrialType[curTest] == 15) { //NrpTestLuresR
        curDicX = NrpTestLuresR[NrpTestLuresRCnt];
        curDic = imageDic.map(function(x) {return x.id; }).indexOf(curDicX);
        TestColOriginal.push(NrpTestLuresRC[NrpTestLuresRCnt]);
        start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, 0, imageDic[curDic], itemA);
        if (NrpTestLuresRCnt <= NrpTestLures.length) {
          NrpTestLuresRCnt++;
        }
      }
      console.log('---t')
      console.log(curTest);
      console.log(TestTrialType[curTest]);
      console.log(imageDic[curDic]);

      TestedImage.push(imageDic[curDic].id);

      setTimeout(function() {
        if (TestTrialType[curTest] > 9) {
          start(ctxA, 'gray', 0, 0, imgWidth, imgHeight, flip, imageDic[curDic], itemA);
        }
      }, itiTime+5); // wait a little bit just to make sure image got switched in time

      setTimeout(function() { // fixation at beginning of trial for itiTime
        if (curTest >= numTest) { // if end of test
          $('#itemA').hide(); // hide object from last trial
          $('#Old').hide(); // hide Old button
          $('#New').hide(); // hide New button

          // open pop-up:
          modalClosed = false;
          document.getElementById("openModal_text").innerHTML =
            'End of Experiment!';
          window.location.href = '#openModal';
          checkFlag4();

          function checkFlag4() {
            if (modalClosed == false) {
              window.setTimeout(checkFlag4, 100); /* this checks the flag every 100 milliseconds*/
            } else {
              Done(); // finish up experiment
              return; // need return; otherwise function below executes
            }
          }
        }
        OldNewJudgment();
      }, itiTime);
    }

    function New() {
      if (curPractice > numPractice) { // if test phase
        TestResp.push(1);
        if (TestTrialType[curTest] == 0) { //RpPlus
          TestAcc.push(0);
        } else if (TestTrialType[curTest] == 1) { //RpMinus
          TestAcc.push(0);
        } else if (TestTrialType[curTest] == 2) { //Nrp
          TestAcc.push(0);
        } else if (TestTrialType[curTest] == 4) { //RpTestLures
          TestAcc.push(1);
        } else if (TestTrialType[curTest] == 5) { //NrpTestLures
          TestAcc.push(1);
        } else if (TestTrialType[curTest] == 10) { //RpPlusR
          TestAcc.push(0);
        } else if (TestTrialType[curTest] == 11) { //RpMinusR
          TestAcc.push(0);
        } else if (TestTrialType[curTest] == 12) { //NrpR
          TestAcc.push(0);
        } else if (TestTrialType[curTest] == 14) { //RpTestLuresR
          TestAcc.push(1);
        } else if (TestTrialType[curTest] == 15) { //NrpTestLuresR
          TestAcc.push(1);
        }
        TestRT.push((new Date().getTime() - startTrial)); // time to respond (in ms)

        if (TestTrialType[curTest] > 9) { // if continuous report trial
          flip = Math.round(Math.random());
          flipList.push(flip);
          randrotate = Math.floor(Math.random() * 360);
          randrotateList.push(randrotate);
          ringctxA.clearRect(0, 0, 600, 600);
          ringctxA.restore();
          ringctxA.save();
          ringctxA.translate(50 + 500 / 2, 50 + 500 / 2);
          ringctxA.rotate(randrotate * Math.PI / 180);
          ringctxA.translate(-50 - 500 / 2, -50 - 500 / 2);
          Continuous();
        } else { // if recognition test
          curTest++;
          NextTestTrial();
        }
      } else { // if practice phase
        PracticeResp.push(1);
        if (PracTrialType[curPractice] == 0) { //RpPlus
          PracticeAcc.push(0);
        } else if (PracTrialType[curPractice] == 3) { //PracLure
          PracticeAcc.push(1);
        } else if (PracTrialType[curPractice] == 10) { //RpPlusR
          PracticeAcc.push(0);
        } else if (PracTrialType[curPractice] == 13) { //PracLureR
          PracticeAcc.push(1);
        }
        PracticeRT.push((new Date().getTime() - startTrial)); // time to respond (in ms)

        if (PracTrialType[curPractice] > 9) { // if continuous report trial
          flip = Math.round(Math.random());
          flipList.push(flip);
          randrotate = Math.floor(Math.random() * 360);
          ringctxA.clearRect(0, 0, 600, 600);
          ringctxA.restore();
          ringctxA.save();
          ringctxA.translate(50 + 500 / 2, 50 + 500 / 2);
          ringctxA.rotate(randrotate * Math.PI / 180);
          ringctxA.translate(-50 - 500 / 2, -50 - 500 / 2);
          Continuous();
        } else { // if recognition test
          curPractice++;
          NextPracTrial();
        }
      }
    }

    function Old() {
      if (curPractice > numPractice) { // if test phase
        TestResp.push(0);
        if (TestTrialType[curTest] == 0) { //RpPlus
          TestAcc.push(1);
        } else if (TestTrialType[curTest] == 1) { //RpMinus
          TestAcc.push(1);
        } else if (TestTrialType[curTest] == 2) { //Nrp
          TestAcc.push(1);
        } else if (TestTrialType[curTest] == 4) { //RpTestLures
          TestAcc.push(0);
        } else if (TestTrialType[curTest] == 5) { //NrpTestLures
          TestAcc.push(0);
        } else if (TestTrialType[curTest] == 10) { //RpPlusR
          TestAcc.push(1);
        } else if (TestTrialType[curTest] == 11) { //RpMinusR
          TestAcc.push(1);
        } else if (TestTrialType[curTest] == 12) { //NrpR
          TestAcc.push(1);
        } else if (TestTrialType[curTest] == 14) { //RpTestLuresR
          TestAcc.push(0);
        } else if (TestTrialType[curTest] == 15) { //NrpTestLuresR
          TestAcc.push(0);
        }
        TestRT.push((new Date().getTime() - startTrial)); // time to respond (in ms)

        if (TestTrialType[curTest] > 9) { // if continuous report trial
          flip = Math.round(Math.random());
          randrotate = Math.floor(Math.random() * 360);
          ringctxA.clearRect(0, 0, 600, 600);
          ringctxA.restore();
          ringctxA.save();
          ringctxA.translate(50 + 500 / 2, 50 + 500 / 2);
          ringctxA.rotate(randrotate * Math.PI / 180);
          ringctxA.translate(-50 - 500 / 2, -50 - 500 / 2);
          Continuous();
        } else { // if recognition test
          curTest++;
          NextTestTrial();
        }
      } else { // if practice phase
        PracticeResp.push(0);
        if (PracTrialType[curPractice] == 0) { //RpPlus
          PracticeAcc.push(1);
        } else if (PracTrialType[curPractice] == 3) { //PracLure
          PracticeAcc.push(0);
        } else if (PracTrialType[curPractice] == 10) { //RpPlusR
          PracticeAcc.push(1);
        } else if (PracTrialType[curPractice] == 13) { //PracLureR
          PracticeAcc.push(0);
        }
        PracticeRT.push((new Date().getTime() - startTrial)); // time to respond (in ms)

        if (PracTrialType[curPractice] > 9) { // if continuous report trial
          flip = Math.round(Math.random());
          randrotate = Math.floor(Math.random() * 360);
          ringctxA.clearRect(0, 0, 600, 600);
          ringctxA.restore();
          ringctxA.save();
          ringctxA.translate(50 + 500 / 2, 50 + 500 / 2);
          ringctxA.rotate(randrotate * Math.PI / 180);
          ringctxA.translate(-50 - 500 / 2, -50 - 500 / 2);
          Continuous();
        } else { // if recognition test
          curPractice++;
          NextPracTrial();
        }
      }
    }

    /* Always track mouse */
    let mouseX, mouseY;
    $(function() {
      $(document).bind('mousemove.overall', function(e) {
        mouseX = e.pageX;
        mouseY = e.pageY;
      });
    });

    /* Done with the experiment */
    function Done() {
      // calculate their overall accuracy (Practice + Test)
      const OverallAcc = (((TestAcc.reduce((a, b) => a + b, 0) + PracticeAcc.reduce((a, b) => a + b, 0)) / (TestAcc.length + PracticeAcc.length)) * 100).toFixed(2);
      let cashpoints = basepay + (OverallAcc/100*3);
      cashpoints = cashpoints.toFixed(2);
      document.getElementById("cashPrize").innerHTML = "Total earnings ($" + basepay + " + bonus): $" + cashpoints;
      document.getElementById("doneText").innerHTML = 'Thanks very much for your participation!<br><br>APlease describe any strategy you used to better remember the images. (Also, do you have any general comments? Any technical difficulties?)<br><br>' + 'Your overall accuracy: ' + OverallAcc +
        '%<br><br><textarea name="comments" id="comments" style="width: 400px; height: 300px"></textarea><br><br>';
      $('#showTrial').hide();
      $('#done').show();
    }

    var Date_info = startDate.getMonth() + '_' + startDate.getDate() + '_' + startDate.getHours();

    /* What to save and put it on server */
    function SaveData() {
      $('#done').children().hide();
      $('#done').hide();
      $('#saving').show();
      const endDate = new Date().getTime();
      const d = {
        "ID": WORKERID,
        "ASSIGNMENTID": ASSIGNMENTID,
        "age": age,
        "sex": sex,
        "StartTime": startDate.getTime(),
        "EndTime": endDate,
        "PracticeResp": PracticeResp,
        "PracticeAcc": PracticeAcc,
        "PracColOriginal": PracColOriginal,
        "PracticeRT": PracticeRT,
        "PracticeColRT": PracticeColRT,
        "PracticeColResp": PracticeColResp,
        "TestResp": TestResp,
        "TestAcc": TestAcc,
        "TestRT": TestRT,
        "TestColRT": TestColRT,
        "TestColResp": TestColResp,
        "TestColOriginal": TestColOriginal,
        "RepeatColResp": RepeatColResp,
        "RpPlusCnt": RpPlusCnt,
        "RpMinusCnt": RpMinusCnt,
        "NrpCnt": NrpCnt,
        "PracLuresCnt": PracLuresCnt,
        "RpTestLuresCnt": RpTestLuresCnt,
        "NrpTestLuresCnt": NrpTestLuresCnt,
        "RpPlusRCnt": RpPlusRCnt,
        "RpMinusRCnt": RpMinusRCnt,
        "NrpRCnt": NrpRCnt,
        "PracLuresRCnt": PracLuresRCnt,
        "RpTestLuresRCnt": RpTestLuresRCnt,
        "NrpTestLuresRCnt": NrpTestLuresRCnt,
        "CDaccuracy": CDaccuracy,
        "RpCats": RpCats,
        "NrpCats": NrpCats,
        "RpPlusExem": RpPlusExem,
        "RpMinusExem": RpMinusExem,
        "PracLuresExem": PracLuresExem,
        "RpTestLuresExem": RpTestLuresExem,
        "NrpExem": NrpExem,
        "NrpTestLuresExem": NrpTestLuresExem,
        "RpCatsR": RpCatsR,
        "NrpCatsR": NrpCatsR,
        "RpPlusC": RpPlusC,
        "RpMinusC": RpMinusC,
        "NrpC": NrpC,
        "PracLuresC": PracLuresC,
        "RpTestLuresC": RpTestLuresC,
        "NrpTestLuresC": NrpTestLuresC,
        "RpPlusRC": RpPlusRC,
        "RpMinusRC": RpMinusRC,
        "NrpRC": NrpRC,
        "PracLuresRC": PracLuresRC,
        "RpTestLuresRC": RpTestLuresRC,
        "NrpTestLuresRC": NrpTestLuresRC,
        "OrigStudyColors": OrigStudyColors,
        "RpPlus": RpPlusT,
        "RpMinus": RpMinusT,
        "Nrp": NrpT,
        "RpPlusR": RpPlusRT,
        "RpMinusR": RpMinusRT,
        "NrpR": NrpRT,
        "PracLures": PracLures,
        "RpTestLures": RpTestLures,
        "NrpTestLures": NrpTestLures,
        "PracLuresR": PracLuresR,
        "RpTestLuresR": RpTestLuresR,
        "NrpTestLuresR": NrpTestLuresR,
        "RpPlus_StudyOrder": RpPlus_StudyOrder,
        "RpMinus_StudyOrder": RpMinus_StudyOrder,
        "Nrp_StudyOrder": Nrp_StudyOrder,
        "RpPlusR_StudyOrder": RpPlusR_StudyOrder,
        "RpMinusR_StudyOrder": RpMinusR_StudyOrder,
        "NrpR_StudyOrder": NrpR_StudyOrder,
        "RpPlus_PracticeOrder": RpPlusPrac,
        "RpPlus_PracticeOrder": RpPlusPracR,
        "StudyTrialType": StudyTrialType,
        "PracTrialType": PracTrialType,
        "TestTrialType": TestTrialType,
        "AllImages": AllImages,
        "randrotate": randrotateList,
        "flip": flipList,
        "TestedImage": TestedImage,
        "PracTestedImage": PracTestedImage,
        "PracTypeList": PracTypeList,
        "TestTypeList": TestTypeList,
        "numRepeats": numRepeats,
        "Repeats": Repeats,
        "RepeatObj": RepeatObj,
        "seed": chance1.seed,
        "comments": $('#comments').val()
      };

      /* save to Firebase server */
      const blob = new Blob([JSON.stringify(d)], {
        type: "application/json"
      });
      const storageRef = firebase.storage().ref('Retrieval_MTurk/' + WORKERID + '.json');
      storageRef.put(blob);

      document.getElementById("saving").innerHTML = "Submitting...";

      /* submit after waiting a few seconds to make sure data got sent */
      setTimeout(function() {
        document.getElementById("saving").innerHTML = "Data saved. Thanks for your participation! You may close this window.";

        // close full screen if still full-screened
        if (document.cancelFullScreen) {
            document.cancelFullScreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.webkitCancelFullScreen) {
            document.webkitCancelFullScreen();
        }
      }, 3000);
    }

    /*check all images are loaded before starting*/
    function ImagesReady() {
      imageDic = [];
      for (var i = 0; i < AllImages.length; i++) {
          // console.log(AllImages[i])
          if (!$('#Obj' + AllImages[i])[0].complete) {
              var percentage = i * 100.0 / (AllImages.length);
              percentage = percentage.toFixed(0).toString() + ' %';

              document.getElementById("loading").innerHTML =
                'Loading images ... ' + percentage + '<br>If more than a minute elapses, try refreshing page.';
              setTimeout('ImagesReady()', 20);
              return;
          } else {
            imageDic[i] = new Image();
            imageDic[i].crossOrigin = "anonymous";
            imageDic[i].id = AllImages[i];
            imageDic[i].src = $('#Obj' + AllImages[i])[0].src;
          }
      }
      $('#loading').hide();
      $('a#TextButton').show();
    };

    function start(context, deg, initX, initY, imgWidth, imgHeight, flip, image, itemID) {
        flip == 0 ? colors = origColors : colors = flippedColors;
        var col = [146.83, 146.83, 146.83]; // luminance-corrected gray
        if (deg != 'gray') {
            deg = (deg >= 360) ? deg - 360 : deg;
            deg = (deg < 0) ? deg + 360 : deg;
            col = colors[deg];
        }
        context.drawImage(image, initX, initY, imgWidth, imgHeight);
        recolor(context, Math.round(col[0]), Math.round(col[1]), Math.round(col[2]), initX, initY, itemID);
    }

    function recolor(context, newR, newG, newB, initX, initY, itemID) {
        imgData = context.getImageData(initX, initY, itemID.width, itemID.height);
        let data = imgData.data;
        for (let i = 0; i < data.length; i += 4) {
            let red = data[i];
            let green = data[i + 1];
            let blue = data[i + 2];
            if (red > 10 && blue < 250) {
                data[i] = newR;
                data[i + 1] = newG;
                data[i + 2] = newB;
            }
        }
        context.putImageData(imgData, initX, initY);
    }

    function wrapDiff(input, comparison) { // deg difference in color space
        if (input < comparison) {
            a = input;
            b = comparison
        } else {
            a = comparison;
            b = input
        }
        degree = Math.abs(a - b);
        if (degree > 180) {
            degree = Math.abs(a - (b - 360))
        }
        if (degree < -180) {
            degree = Math.abs(a - (b + 360))
        }
        return wrap(degree);
    }

    function arrayContains(needle, arrhaystack) {
      return arrhaystack.indexOf(needle);
    }

    /* running on IE? */
    function isIE() {
      ua = navigator.userAgent;
      var is_ie = ua.indexOf("MSIE ") > -1 || ua.indexOf("Trident/") > -1;
      return is_ie;
    }

    function bandwidth_test(){
      // Let's initialize the primitives
      var startedTime, endTime, fileSize;
      // Set up the AJAX to perform
      var xhr = new XMLHttpRequest();
      // Rig the call-back... THE important part
      xhr.onreadystatechange = function () {
        // we only need to know when the request has completed
        if (xhr.readyState === 4 && xhr.status === 200) {
          // Here we stop the timer & register end time
          endTime = (new Date()).getTime();
          // Also, calculate the file-size which has transferred
          fileSize = xhr.responseText.length;
          // Calculate band_speed as global variable; the connection-speed in kbps
          band_speed = (fileSize * 8) / ((endTime - startedTime)/1000) / 1024;
          if (window.chrome == undefined) { // not Chrome
            $('body').html('Please run this experiment in Google Chrome.');
          } else { // is Chrome
            if (band_speed < 3) {
              $('body').html('Unfortunately your internet speed is too slow for this experiment to operate as intended... Sorry!');
            }
          }
        }
      }
      // Snap back; here's where we start the timer
      startedTime = (new Date()).getTime();
      // All set, let's hit it! Should be an image hosted by you, of small file size
      xhr.open("GET", "https://paulscotti.github.io/mturk/InterGroup_Spatial_files/objects/Object999.jpg", true);
      xhr.send();
    }

    $(function() { // check if Safari, IE, mobile, or slow internet
        if (!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/)) { // if Safari
            $('body').html('Unfortunately this HIT does not work in Safari. It works in Chrome, Firefox, or Opera. Sorry!');
        } else if (isIE()) { // if IE
            $('body').html('Unfortunately this HIT does not work in Internet Explorer. It works in Chrome, Firefox, or Opera. Sorry!');
        } else if (
            /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i
            .test(navigator.userAgent) ||
            /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i
            .test(navigator.userAgent.substr(0, 4))) {
            $('body').html('Unfortunately this HIT does not work on mobile devices. It works on desktop versions of Chrome, Firefox, or Opera. Sorry!'); // dont allow mobile
        } else {
          bandwidth_test();
        }
    });

    function requestFullScreen() {

      var el = document.body;

      // Supports most browsers and their versions.
      var requestMethod = el.requestFullScreen || el.webkitRequestFullScreen ||
        el.mozRequestFullScreen || el.msRequestFullScreen;

      if (requestMethod) {

        // Native full screen.
        requestMethod.call(el);

      } else if (typeof window.ActiveXObject !== "undefined") {

        // Older IE.
        var wscript = new ActiveXObject("WScript.Shell");

        if (wscript !== null) {
          wscript.SendKeys("{F11}");
        }
      }
    }

    function modalContinue() {
      modalClosed = true;
    }

    function checkFlag5() {
      if (modalClosed == false) {
        window.setTimeout(checkFlag5, 100); /* this checks the flag every 100 milliseconds*/
      } else {
        $('#SameButton').hide();
        $('#DiffButton').hide();
        curCD++;
        ChangeDetection()
      }
    }
  </script>
</body>

</html>
