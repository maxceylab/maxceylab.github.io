<!-- Paul Scotti 2019 -->
<!-- Set code as .html file -->
<html>

<!-- Preload javascript and css files -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
  <script src="https://maxceylab.github.io/expts/js_code/jquery.min.js"></script>
  <script src="https://maxceylab.github.io/expts/js_code/seedrandom.js"></script>
  <script src="https://maxceylab.github.io/expts/js_code/jcanvas.min.js"></script>
  <script src="https://maxceylab.github.io/expts/js_code/chance.js"></script>
  <script>const chance1 = Chance(Date()); Math.seedrandom(chance1.seed); // Use current time as the shuffle seed, so you can trace back their trials</script>
  <script src="https://maxceylab.github.io/expts/js_code/lodash.core.js">// Allows _clone</script>

  <!-- Preload images -->
  <script src="https://maxceylab.github.io/expts/quarters/loadimg.js"></script>
  <script src="https://maxceylab.github.io/expts/quarters/initVariables.js"> </script>

  <!-- load Firebase server javascript, we are using it for storage -->
  <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>

  <link rel="stylesheet" type="text/css" href="https://maxceylab.github.io/expts/quarters/contReport.css">
  <link rel="stylesheet" type="text/css" href="https://maxceylab.github.io/expts/quarters/showTrials.css">
  <link rel="stylesheet" type="text/css" href="https://maxceylab.github.io/expts/quarters/experiment.css">

</head>

<body>

  <!-- Consent statement -->
  <div id="consentDiv">
    <h1>The Ohio State University Consent to Participate in Research</h1>
    <h2>Study Title: [APPROVED IRB TITLE HERE]</h2>
    <p><b>This is a consent form for research participation.</b> It contains important information about this study and what to expect if you decide to participate.</p>
    <p><b>Your participation is voluntary.</b></p>
    <p>Please consider the information carefully. Feel free to email questions to the researchers before making your decision whether or not to participate. If you decide to participate, you will be asked to click a button below this form.</p>
    <p><b>Purpose:</b> In this experiment, we are interested in understanding how humans are able to control their attention to focus on relevant information, and how attention is related to other cognitive abilities and traits.</p>
    <p><b>Procedures/Tasks:</b> Your participation involves watching various visual events on a computer screen and responding to what you saw. Additionally, you may be asked to complete a survey. You will be provided with detailed written
      instructions at the start of each task or survey.</p>
    <p><b>Duration:</b> The experiment is expected to take the duration listed on the next page. You may leave the study at any time. If you decide to stop participating in the study, there will be no penalty to you, and you will not lose
      any benefits to which you are otherwise entitled. Your decision will not affect your future relationship with The Ohio State University.</p>
    <p><b>Risks and Benefits:</b> There is no more risk associated with participation than you would normally encounter while playing a simple video game. Benefits include advancing scientific knowledge, experiencing the research process, and
      learning about attention and cognitive control.</p>
    <p><b>Confidentiality:</b> Only authorized personnel will have access to your data. No identifiable information will be saved.</p>
    <p>The data that you provide in the experiment will be stored temporarily on a secure private online server, then transferred to our secure lab computers. Only select lab personnel who have received training in human subjects protection and
      clearance to handle data for this project will have access to your results. We will work to make sure that no one sees
      your data without approval. But, because we are using the Internet, there is a chance that someone could access your online responses without permission. In some cases, this information could be used to identify you. Your data will be
      protected with a code to reduce the risk that other people can view the responses. However, there are rare instances when the researcher may be required to share personally identifiable information. For example, in response to a
      complaint about the research, officials at The University and/or regulatory oversight government agencies (National Science Foundation) may access research data. The researcher is also required by law to report certain information to
      government and/or law enforcement officials (e.g., threatened violence against self or others, communicable diseases).</p>
    <p><b>Participant Rights:</b> You may refuse to participate in this study without penalty or loss of benefits to which you are otherwise entitled. If you are a student or employee at Ohio State, your decision will not affect your grades or
      employment status.</p>
    <p>If you choose to participate in the study, you may discontinue participation at any time without penalty or loss of benefits. By consenting below, you do not give up any personal legal rights you may have as a participant in this study.</p>
    <p>An Institutional Review Board responsible for human subjects research at The Ohio State University reviewed this research project and found it to be acceptable, according to applicable state and federal regulations and University policies
      designed to protect the rights and welfare of participants in research.</p>
    <p><b>Contacts and Questions:</b> For questions, concerns, or complaints about the study, or you feel you have been harmed as a result of study participation, you may contact Paul Scotti at scotti.5@osu.edu. For questions about your rights
      as a participant in this study or to discuss other study-related concerns or complaints with someone who is not part of the research team, you may contact Ms. Sandra Meadows in the Office of Responsible Research Practices at
      meadows.8@osu.edu.</p>
    <p><b>Electronic consent:</b> You may print a copy of this consent form for your records. If you wish to continue with the experiment, please click the button below.<br>
      <center><b>Clicking the button below indicates that:</b><br>You have read the above information<br>You are 18 years of age or older<br>You voluntarily agree to participate<br>
    </p><br></center>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#consentDiv').hide();$('#instructions').show();document.body.scrollTop = document.documentElement.scrollTop = 0;$('a#TextButton').show()" id="TextButton" style="display: inline;">I
        consent to participate in this study</a></p>
  </div>

  <!-- Instructions page1 -->
  <div id="instructions" style="display: none">
    <center><b>
        <p>This experiment is a memorization task involving visual images. It will take approximately XX minutes to complete.</p>
        <p>Do not complete this experiment more than once, and please refrain from prolonged breaks once the experiment begins.</p>
        <p>Please do not disable the creation of text dialogs as these will be used to relay instructions.</p>
      </b></center>
    <br>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions').hide();$('#instructions2').show();$('a#TextButton').hide();ImagesReady();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton">Next
        (1 of 2)</a></p>
  </div>

  <!-- Instructions page2 -->
  <div id="instructions2" style="display:none">
    <center><b>
        <p>You will be presented with 72 objects, one at a time, each presented for 5 seconds.</p>
        <p>Study the visual details of these objects for a later memory test.</p><br>

        <p align="center"><img src="https://maxceylab.github.io/stimuli/instruction_images/white_grand_piano.jpg" width="200px"></p>

        <p>Memory for objects will need to be as detailed as "white grand piano", for example, simply memorizing "piano" for the above image would not be helpful during testing.</p><br>
        <p>The rest of the instructions will be provided when relevant via text pop-ups.</p>
      </b></center>
    <br>
    <p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions5').hide();StartExperiment();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton">Start Experiment</a></p>
    <center>
      <p id=loading>Images loading... Please wait.</p>
  </div>

  <!-- Screen after submitting expt -->
  <div id="done">
    <div id="doneText">Thanks very much for your participation!<br><br>Any comments for us? (Was it fun? Any technical difficulties?)<br><br>
      <textarea name="comments" id="comments" style="width: 400px; height: 300px"></textarea>
      <center>
        <p>
          <div id="cashPrize">text
      </center>
    </div>
    </p>
    <a href="javascript:void(0);" onclick="SaveData()" id="submitForm">Click to Submit</a>
  </div>
  <div id="saving">Saving . . .</div>
  </div>

  <!-- Display Object HTML -->
  <div id="showTrial">
    <div id="fixation">+</div>
    <div id="allItems">
      <div id='itemA_abs' style="position:absolute; top:150px; left:0px;">
        <canvas id="itemA" width=300 height=300></canvas></div>
      <div id='itemB_abs' style="position:absolute; top:150; left:300px;">
        <canvas id="itemB" width=300 height=300></canvas></div>
      <canvas id="CDitem" width=300 height=300></canvas>
    </div><br><br>
    <center><a href="javascript:void(0);" onclick="SamePress();ChangeDetection();" id="SameButton" style="display: hidden; ">Same</a>
      <a href="javascript:void(0);" onclick="DiffPress();ChangeDetection();" id="DiffButton" style="display: hidden;">Different</a>
      <div id="underText2">
        <p>Did this square stay the same color or change to a different color?</p>
      </div>
    </center>
  </div>

  <!-- Continuous Report HTML -->
  <div id="continuousReport">
    <div id='contItem_abs' style="position:absolute;">
      <canvas id="contItemA" width=600 height=600></canvas></div>
    <!-- <div id='contItemB_abs' style="position:absolute; top:150; left:300px;">
<canvas id="contItemB" width=300 height=300></canvas></div> -->
    <canvas id="ringItemA" width=600 height=600 style="position: absolute;"></canvas>
    <!-- <canvas id="ringItemB"  width=280 height=280 style="position: absolute; top:160px; left:310px;"></canvas> -->
    <div id="pointer"></div>
    <div id="popQuiz">
      <p>What was the color of this object?/p>
    </div>
    <div id="underText">
      <p></p>
    </div>
  </div>

  <!-- Continuous Report Feedback (Practice) HTML -->
  <div id="feedback">
    <div id="feedbackReportedText">Your response:</div><canvas id="feedbackReportedTri" width=300 height=300></canvas>
    <div id="feedbackCorrectText">Correct response:</div><canvas id="feedbackCorrectTri" width=300 height=300></canvas>
    <div id="feedbackError">Your error was: 10 deg (aim for less than 50 degrees!).<br>Click to continue.</div>
  </div>

  <!-- Survey: Strategy? -->
  <form id="survey1" style="display: none;">
    <center>
      <div id="doneText">
        <p>You finished! Just a few questions before you go:<p><br>
            <p>What strategy (if any) did you use when selecting the colors of objects?</p>
      </div>
      <br><br><br><br>
      <textarea name="strategy" id="strategy" style="width: 400px; height: 200px"></textarea><br><br>
      <a href="javascript:void(0);" onclick="Done();" id="TextButton" style="display: inline;">Submit</a>
    </center>
  </form>

  <!-- Survey: Regularities? -->
  <form id="survey2" style="display: none;">
    <center>
      <div id="doneText">
        <p>Do you think object colors were sampled randomly from the color wheel or do you think objects often shared approximately the same color?</p>
      </div>
      <br><br><br><br>
      <input name="choice" type="radio" value="nope" id="surveyresponseRand" /> Each color chosen at random
      <br><br>
      <input name="choice" type="radio" value="yes" id="surveyresponsePref" /> Some portion of colors chosen more than others
      <br><br><br><br>
      <a href="javascript:void(0);" onclick="Survey();" id="TextButton" style="display: inline;">Submit</a>
    </center>
  </form>

  <!-- Survey: Certainty? -->
  <form id="survey3" style="display: none;">
    <center>
      <div id="doneText">
        <p>How confident are you that the biased color region you selected is close to the actual experimental manipulation?</p>
      </div>
      <br><br><br><br>
      <div class="likertButtons">
        Less certain
        <label for="likert1">1<input id="likertConfidence" type="radio" name="likertz" value="1"></label>
        <label for="likert2">2<input id="likertConfidence" type="radio" name="likertz" value="2"></label>
        <label for="likert3">3<input id="likertConfidence" type="radio" name="likertz" value="3"></label>
        <label for="likert4">4<input id="likertConfidence" type="radio" name="likertz" value="4"></label>
        <label for="likert5">5<input id="likertConfidence" type="radio" name="likertz" value="5"></label>
        <label for="likert6">6<input id="likertConfidence" type="radio" name="likertz" value="6"></label>
        More certain
      </div>
      <br><br>
      <a href="javascript:void(0);" onclick="Done();" id="TextButton" style="display: inline;">Submit</a>
    </center>
  </form>

  <!-- Initializing JS -->
  <script>
    /* Initialize Firebase */
    const config = {
      apiKey: "AIzaSyBeD1E8RCvOck3CeWzXbg2hGURf-sSrx8A",
      authDomain: "scotti-92222.firebaseapp.com",
      databaseURL: "https://scotti-92222.firebaseio.com",
      projectId: "scotti-92222",
      storageBucket: "scotti-92222.appspot.com",
      messagingSenderId: "123079954596"
    };
    firebase.initializeApp(config);

    /* Disable context/right-click menu */
    // document.oncontextmenu = function() {
    //     return false;
    // }

    /* Define more variables */
    const numStudy = 72;
    const numPractice = 72;
    const numTest = 144;
    let curTrial = 0;

    /* Setup reused image variable */
    let imgA = new Image();
    imgA.crossOrigin = "anonymous";

    /* Setup CD images */
    let imgCD = new Image();
    imgCD.crossOrigin = "anonymous";
    imgCD.src = $('#diff1')[0].src;
    let CDfix = new Image();
    CDfix.crossOrigin = "anonymous";
    CDfix.src = $('#CDfixation')[0].src;
    let imgCDtest = new Image();
    imgCDtest.crossOrigin = "anonymous";
    imgCDtest.src = $('#diff2')[0].src;

    /* Setting up canvas contexts */
    const itemA = document.getElementById("itemA");
    const ctxA = itemA.getContext("2d");
    const CDitem = document.getElementById("CDitem");
    const cdctx = CDitem.getContext("2d");

    /* Start by hiding text */
    $('#popQuiz').hide();

    /* Start Experiment */
    function StartExperiment() {
      age = prompt('Before we start, can you tell me how old you are (in years)?');

      while (!(age > 0)) {
        age = prompt('Can you tell me how old you are (in years)?');
      }

      sex = prompt('And are you male (M), female (F), non-binary (B), or prefer not to answer (NA)?');

      while (!(sex == 'M' || sex == 'F' || sex == 'B' || sex == 'NA' || sex == 'm' || sex == 'f' || sex == 'b' || sex == 'na' || sex == 'female' || sex == 'male' || sex == 'Female' || sex == 'Male')) {
        sex = prompt('Are you male (M), female (F), non-binary (B), or prefer not to answer (NA)? Type one of the options shown in parentheses.');
      }
      if (sex == 'M' || sex == 'm' || sex == 'male' || sex == 'Male') {
        sex = 'm';
      } else if (sex == 'F' || sex == 'f' || sex == 'female' || sex == 'Female') {
        sex = 'f';
      } else if (sex == 'B' || sex == 'b') {
        sex = 'b';
      } else if (sex == 'NA' || sex == 'na') {
        sex = 'na';
      }

      alert('Your subject ID is: ' + chance1.seed + '. Hold on to this ID in case you ever need the experimenter to look up your data, or in case technical difficulties arise. Note that your work is saved only at the very beginning and the very end of the experiment.')

      // save a file letting me know that someone made it this far
      const blobx = new Blob([JSON.stringify(chance1.seed)], {
        type: "application/json"
      });
      const storageRefx = firebase.storage().ref('started/' + chance1.seed + '.json');
      storageRefx.put(blobx);

      $('#instructions').hide();
      NextStudyTrial();
    }

    /* Study Phase Start */
    function NextStudyTrial() {
      curTrial++;

      if (curTrial > numStudy) { // if end of study
          alert("End of Study Phase!");
          $('#showTrial').hide();
          curPractice = 0;
          NextPracTrial(); // start Practice Phase
          return; // need return; otherwise the ShowTrial below executes
      }
      ShowStudy();
    }

    /* Display Object */
    function ShowStudy() {
      //Wait for click; then show the stimuli for this trial; then delay for fixed ISI; then call ShowContinuousReport
      start(ctxA, trialStruct.itemA_col, 50, 50, imgWidth, imgHeight, flip, imgA, itemA);

      imgA.src = $('#' + trialStruct.itemA_id)[0].src;

      $('#allItems').css('margin-top', -1000);
      $('#showTrial').show();
      setTimeout(function() {
        $('#allItems').css('margin-top', 0);
        setTimeout(function() {
          ctxA.onload = function() {
            ctxA.drawImage(Mask, 50, 50, imgWidth, imgHeight);
          }
          ctxA.drawImage(Mask, 50, 50, imgWidth, imgHeight);
          setTimeout(function() {
            $('#allItems').css('margin-top', -1000);
            setTimeout(function() {
              $('#showTrial').hide();
              NextFeedTrial();
            }, isiTime);
          }, maskTime);
        }, displayTime);
      }, 500);
    }

    /* Decide next trial or next phase */
    function NextFeedTrial() {
      if (blockStart == 0) {
        currentFeedTrial++;
        if (currentFeedTrial > numTrialsPerPart[currentPart] - 1) { //if last test trial
          if (currentPart > 0) {
            $('showTrial').hide;
            Survey1();
            return;
          } else { //if last practice trial
            currentFeedTrial = -1;
            currentPart++;
            alert("Okay, time for the real experiment. You will receive a monetary bonus the better you perform. Thank you and we wish you the best of luck!");
            points = 0;
            currentTrial = -1;
            // imgX.src = $('#' + r_totalTrials[2][0].itemA)[0].src; /* preload first image of test phase */
            NextTrial();
            return;
          }
          //} else if (currentFeedTrial > 0 && currentFeedTrial % trialsPerBlock == 0 && currentPart == 1 && blockStart == 0) { //if last test trial in block
          //currentPart = 1;
          //alert('/')
          // /* Go back to study phase */
          // // alert("Starting study phase (Block "+block+" of "+totBlocks+").");
          // // imgX.src = $('#' + r_totalTrials[2][currentFeedTrial].itemA)[0].src; /* preload image */
          // NextTrial();
          // return;
        }
      } else {
        blockStart = 0;
      }

      /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
      // if (left_or_right == 1) {
      ringctxA.restore();
      ringctxA.drawImage(ringImg, 50, 50, 500, 500);
      ringctxA.save();
      // } else {
      //   ringctxB.restore();
      //   ringctxB.drawImage(ringImg,0,0,280,280);
      //   ringctxB.save();
      // }

      if (!(currentPart == 0 && currentFeedTrial == 0)) { //dont clear ring if its first time ever presented, otherwise first practice trial has no ring
        ringctxA.clearRect(0, 0, 600, 600);
        // ringctxB.clearRect(0,0,600,600);
      }
      mouseInit = mouseX;
      ShowContinuousReport(r_totalTrials[currentPart][currentFeedTrial]);
      mouseMoved = 0;
    }

    let mouseX, mouseY;
    /* Always track mouse */
    $(function() {
      $(document).bind('mousemove.overall', function(e) {
        mouseX = e.pageX;
        mouseY = e.pageY;
      });
    });

    /* Continuous Report */
    function ShowContinuousReport(trialStruct) {
      angleDeg = 0;
      curError = 360;
      startTime = new Date();
      $("#continuousReport").show(); /* Refresh the page to update same context set to new img src */

      $(document).bind('mousemove.curTrial', function(e) {
        parentOffset = $('#continuousReport').offset();
        relX = e.pageX - parentOffset.left - centerX;
        relY = e.pageY - parentOffset.top - centerY;
        curAngle = Math.atan2(relY, relX);
        angleDeg = curAngle / Math.PI * 180.0;
        if (mouseMoved == 0) {
          if (mouseInit != mouseX) {
            setTimeout(function() {
              imgNum = Math.round(wrap([angleDeg - randrotate]));
              startingColor = imgNum;
              mouseMoved = 1;
              // if (repeat == 0) {
              // if (left_or_right == 1) {
              start(ctx2a, imgNum, 200, 200, imgWidth, imgHeight, flip, imgA, itemA);
              mouseMoved = 1;
            }, 400);
          }
        } else {
          imgNum = Math.round(wrap([angleDeg - randrotate]));
          start(ctx2a, imgNum, 200, 200, imgWidth, imgHeight, flip, imgA, itemA);
        }
        // } else {
        //   start(ctx2b,imgNum,50, 50,imgWidth,imgHeight,flip,imgB,itemB);
        // }
        // } else if (repeat == 1) {
        //   start(ctx2,imgNum,50, 50,imgWidth,imgHeight,flip,imgPop);
        // }

        if (survey == 1 && repeat == 0) {
          imgA.src = $('#999')[0].src;
          // imgB.src = $('#999')[0].src;
          // Draw fixed 45 degree highlight
          // if (left_or_right == 1) {
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, curAngle + 180 + Math.PI * 4, curAngle, 1);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, curAngle + 180 - Math.PI * 4, curAngle, 0);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, curAngle + Math.PI / 4, curAngle, 1);
          ctx2a.lineWidth = 40;
          ctx2a.strokeStyle = 'black';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, curAngle - Math.PI / 4, curAngle, 0);
          ctx2a.lineWidth = 40;
          ctx2a.strokeStyle = 'black';
          ctx2a.stroke();
          // } else {
          //   ctx2b.beginPath();
          //   ctx2b.arc(centerX, centerY, radius, curAngle+180+Math.PI*4, curAngle, 1);
          //   ctx2b.lineWidth = 30;
          //   ctx2b.strokeStyle = 'white';
          //   ctx2b.stroke();
          //   ctx2b.beginPath();
          //   ctx2b.arc(centerX, centerY, radius, curAngle+180-Math.PI*4, curAngle, 0);
          //   ctx2b.lineWidth = 30;
          //   ctx2b.strokeStyle = 'white';
          //   ctx2b.stroke();
          //   ctx2b.beginPath();
          //   ctx2b.arc(centerX, centerY, radius, curAngle + Math.PI/4, curAngle, 1);
          //   ctx2b.lineWidth = 25;
          //   ctx2b.strokeStyle = 'black';
          //   ctx2b.stroke();
          //   ctx2b.beginPath();
          //   ctx2b.arc(centerX, centerY, radius, curAngle - Math.PI/4, curAngle, 0);
          //   ctx2b.lineWidth = 25;
          //   ctx2b.strokeStyle = 'black';
          //   ctx2b.stroke();
          // }
        } else {
          imgA.src = $('#' + trialStruct.itemT_id)[0].src;
          // imgB.src = $('#' + dx.pracimgB[currentFeedTrial])[0].src;
        }

        if (survey == 0) {
          // if (left_or_right == 1) {
          $('#pointer').css({
            'left': centerX + Math.cos(curAngle) * ringSize - 9,
            'top': centerY + Math.sin(curAngle) * ringSize - 9
          });
          // } else {
          //   $('#pointer').css({'left': centerX+150 + Math.cos(curAngle)*ringSize-10,
          //                     'top': centerY + Math.sin(curAngle)*ringSize-10});
          // }
        } else {
          $('#pointer').hide();
        }

        if (survey == 1) {
          // flip == 0? curError = Math.abs(wrap([imgNum-seed[0]])) : curError = Math.abs(wrap([wrap([180-imgNum])-seed[0]]));
        } else {
          // if (left_or_right == 1) {
          curError = Math.abs(wrap([imgNum - trialStruct.itemT_col]));
          // } else {
          //   flip == 0? curError = Math.abs(wrap([imgNum-trialStruct.itemB])) : curError = Math.abs(wrap([wrap([180-imgNum])-trialStruct.itemB]));
          // }
        }
        if (curError > 180) {
          curError = Math.abs(360 - curError);
        }

        if (e.isFakeTrigger) { // this code only executes once before anything else happens, e.g. otherwise randrotate would be next trial's randrotate
          trialStruct.startingColor = startingColor;
          trialStruct.randrotate = randrotate;
          trialStruct.flip = flip;
          flip == 0 ? ringImg.src = $('#ring')[0].src : ringImg.src = $('#ringFlip')[0].src;
          ringctxA.translate(50 + 500 / 2, 50 + 500 / 2);
          ringctxA.rotate(randrotate * Math.PI / 180);
          ringctxA.translate(-50 - 500 / 2, -50 - 500 / 2);
          ringImg.onload = function() {
            ringctxA.drawImage(ringImg, 50, 50, 500, 500);
          }
          ctx2a.onload = function() {
            start(ctx2a, 'gray', 200, 200, imgWidth, imgHeight, flip, imgA, itemA); //set starting color as grayscale
          }
          start(ctx2a, 'gray', 200, 200, imgWidth, imgHeight, flip, imgA, itemA);
        }
        if ((currentFeedTrial % trialsPerBlock) == 0) { // needed special code for first item of test phase showing as grayscale, no idea why
          if (tempVar) {
            setTimeout(function() {
              // if (left_or_right == 1) {
              ctx2a.onload = function() {
                start(ctx2a, 'gray', 200, 200, imgWidth, imgHeight, flip, imgA, itemA); //set starting color as grayscale
              }
              start(ctx2a, 'gray', 200, 200, imgWidth, imgHeight, flip, imgA, itemA);
              //   start(ctx2a,'gray',175, 175, imgWidth, imgHeight, flip, imgA, itemA);
              //   ctx2b.onload = function() {
              //     start(ctx2b,trialStruct.itemB,50, 50, imgWidth, imgHeight, 0, imgB, itemB); //set starting color as grayscale
              //   }
              //   start(ctx2b,trialStruct.itemB,50, 50, imgWidth, imgHeight, 0, imgB, itemB);
              // } else {
              // ctx2b.onload = function() {
              //   start(ctx2b,'gray',50, 50, imgWidth, imgHeight, flip, imgB, itemB); //set starting color as grayscale
              // }
              // start(ctx2b,'gray',50, 50, imgWidth, imgHeight, flip, imgB, itemB);
              // }
            }, 150);
            tempVar = false;
          }
        }
      });

      $(document).bind('click.curTrial', function(e) {
        if (survey == 1) {
          explicitColor = flip == 0 ? Math.round(wrap([angleDeg - randrotate])) : Math.round(wrap([180 - wrap([angleDeg - randrotate])]));
        } else if (currentPart == 2 && ((new Date()) - startTime) < 500) {
          if (currentFeedTrial % trialsPerBlock != 0) {
            alert('Please take your time when making responses! We will not be able to use your data if it is too noisy! Thanks.');
          }
          tooFast.push(1);
        }

        if (mouseMoved != 0) {
          trialStruct.reportedAngle = Math.round(angleDeg);
          trialStruct.reportedColor = Math.round(wrap([angleDeg - randrotate]));
          trialStruct.rt = (new Date()) - startTime;
          trialStruct.trialTimeStart = startTime;
          trialStruct.col_diff = curError;
          $(document).unbind('click.curTrial');
          $(document).unbind('mousemove.curTrial');
          $(document).unbind('mousedown.curTrial');
          $(document).unbind('mouseup.curTrial');
          $("#continuousReport").hide();
          if (currentPart == 0 && currentFeedTrial == 0) {
            alert('Now highlight the smallest range of colors you think contains the correct color. To highlight, click and drag, starting from one end of the highlight to the other end of the highlight.')
          }
          if (survey == 0) {
            ShowConfidence(trialStruct, angleDeg);
            $('#popQuiz').hide();
          } else {
            var expConfirm = confirm("Is this your selection? [Cancel] to redo.");
            if (expConfirm == true) {
              Survey3();
            } else {
              ShowContinuousReport({
                mean: seed[0],
                type: "color",
                isPractice: 0,
                items: 999
              });
              return;
            }
          }
        }
      });

      e = $.Event('mousemove');
      e.pageX = mouseX;
      e.pageY = mouseY;
      e.isFakeTrigger = true;
      $(document).trigger(e);
    }

    /* Confidence Pt 1 */
    function ShowConfidence(trialStruct, angleDeg) {
      angleDeg2 = 0;
      startTime = new Date();
      startAngle = angleDeg * Math.PI / 180;
      lastRot = 0;
      noMore = 0;
      diffAng2 = -999;

      /* Confidence report */
      $(document).bind('mousemove.curTrial', function(e) {
        parentOffset = $('#continuousReport').offset();
        relX = e.pageX - parentOffset.left - centerX;
        relY = e.pageY - parentOffset.top - centerY;
        curAngle = Math.atan2(relY, relX);
        angleDeg2 = curAngle / Math.PI * 180.0;
        diffAng2 = wrap([wrap([angleDeg]) - wrap([angleDeg2])]) > 180 ? wrap([wrap([angleDeg2]) - wrap([angleDeg])]) : wrap([wrap([angleDeg]) - wrap([angleDeg2])]);
      });

      $(document).bind('mousedown.curTrial', function(e) {
        // if (left_or_right == 1) {
        if (wrap([wrap([angleDeg]) - wrap([angleDeg2])]) < 180 && noMore == 0) {
          /* conf is counterclockwise */
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle, curAngle, 1);
          ctx2a.lineWidth = 40;
          ctx2a.strokeStyle = 'black';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
          lastRot = 1;
          lastRotMat.push(lastRot);
        } else if (wrap([wrap([angleDeg]) - wrap([angleDeg2])]) > 180 && noMore == 0) {
          /* conf is clockwise */
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle, curAngle, 0);
          ctx2a.lineWidth = 40;
          ctx2a.strokeStyle = 'black';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
          lastRot = 0;
          lastRotMat.push(lastRot);
        }
        // } else {
        //   if (wrap([wrap([angleDeg])-wrap([angleDeg2])])<180 && noMore == 0) { /* conf is counterclockwise */
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle, curAngle, 1);
        //     ctx2b.lineWidth = 25;
        //     ctx2b.strokeStyle = 'black';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //     lastRot = 1; lastRotMat.push(lastRot);
        //   } else if (wrap([wrap([angleDeg])-wrap([angleDeg2])])>180 && noMore == 0) { /* conf is clockwise */
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle, curAngle, 0);
        //     ctx2b.lineWidth = 25;
        //     ctx2b.strokeStyle = 'black';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //     lastRot = 0; lastRotMat.push(lastRot);
        //   }
        // }
        trialStruct.rt2 = (new Date()) - startTime;
        imgNum3 = Math.round(wrap([angleDeg2 - randrotate])); // =imgNum2; in case they double click and imgNum3 doesnt get defined
        ShowConfidence2(trialStruct, angleDeg, angleDeg2, diffAng2, lastRot);
        noMore = 1;
      })

      $("#continuousReport").show();
      e = $.Event('mousemove');
      e.pageX = mouseX;
      e.pageY = mouseY;
      e.isFakeTrigger = true;
      $(document).trigger(e);
    }

    /* Confidence Pt 2 */
    function ShowConfidence2(trialStruct, angleDeg, angleDeg2, diffAng2, lastRot) {
      angleDeg3 = 0;
      startTime = new Date();
      startAngle = angleDeg * Math.PI / 180;
      startAngle2 = angleDeg2 * Math.PI / 180;
      LastLock = 0;

      /* Confidence report */
      $(document).bind('mousemove.curTrial', function(e) {
        parentOffset = $('#continuousReport').offset();
        relX = e.pageX - parentOffset.left - centerX;
        relY = e.pageY - parentOffset.top - centerY;
        curAngle = Math.atan2(relY, relX);
        angleDeg3 = curAngle / Math.PI * 180.0;
        diffAng3 = wrap([wrap([angleDeg]) - wrap([angleDeg3])]) > 180 ? wrap([wrap([angleDeg3]) - wrap([angleDeg])]) : wrap([wrap([angleDeg]) - wrap([angleDeg3])]);
        // if (left_or_right == 1) {
        if (wrap([wrap([angleDeg]) - wrap([angleDeg3])]) < 180 + (180 - diffAng2) && lastRot == 0) {
          /* conf is counterclockwise */
          if (wrap([wrap([angleDeg2]) - wrap([angleDeg3])]) < 180) {
            LastLock = 0;
          } else {
            LastLock = 1;
          }
          imgNum3 = Math.round(wrap([(curAngle / Math.PI * 180.0) - randrotate]));
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle, curAngle, 1);
          ctx2a.lineWidth = 40;
          ctx2a.strokeStyle = 'black';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle + diffAng2 * Math.PI / 180, curAngle, 0);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
        } else if (wrap([wrap([angleDeg]) - wrap([angleDeg3])]) > 180 - (180 - diffAng2) && lastRot == 1) {
          /* conf is clockwise */
          if (wrap([wrap([angleDeg2]) - wrap([angleDeg3])]) < 180) {
            LastLock = 1;
          } else {
            LastLock = 0;
          }
          imgNum3 = Math.round(wrap([(curAngle / Math.PI * 180.0) - randrotate]));
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle, curAngle, 0);
          ctx2a.lineWidth = 40;
          ctx2a.strokeStyle = 'black';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle - diffAng2 * Math.PI / 180, curAngle, 1);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
        }
        // } else {
        //   if (wrap([wrap([angleDeg])-wrap([angleDeg3])])<180+(180-diffAng2) && lastRot == 0) { /* conf is counterclockwise */
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle, curAngle, 1);
        //     ctx2b.lineWidth = 25;
        //     ctx2b.strokeStyle = 'black';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle + diffAng2*Math.PI/180, curAngle, 0);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //   } else if (wrap([wrap([angleDeg])-wrap([angleDeg3])])>180-(180-diffAng2) && lastRot == 1) { /* conf is clockwise */
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle, curAngle, 0);
        //     ctx2b.lineWidth = 25;
        //     ctx2b.strokeStyle = 'black';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle - diffAng2*Math.PI/180, curAngle, 1);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //   }
        // }
      });

      $(document).bind('mouseup.curTrial', function(e) {
        if (trialStruct.isPractice) {
          var expConfirm2 = confirm("Continue or redo highlighting? [Cancel] to re-highlight.");
          if (expConfirm2 == false) {
            highlightedColors = [];
            $(document).unbind('click.curTrial');
            $(document).unbind('mousemove.curTrial');
            $(document).unbind('mousedown.curTrial');
            $(document).unbind('mouseup.curTrial');
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, Math.PI, Math.PI, 0);
            ctx2a.arc(centerX, centerY, radius, Math.PI, -Math.PI, 0);
            ctx2a.lineWidth = 50;
            ctx2a.strokeStyle = 'white';
            ctx2a.stroke();
            ShowConfidence(trialStruct, angleDeg);
            return;
          } else {
            ctx2a.clearRect(0, 0, 600, 600); // erases the black highlighting
            // ctx2b.clearRect(0,0,600,600); // erases the black highlighting

            pointsA = (curError - 45) / (0 - 45);
            if (pointsA < 0) {
              pointsA = 0;
            }

            encap = 0;
            imgNum2 = Math.round(wrap([angleDeg2 - randrotate]));
            ang1 = wrap(imgNum)
            ang2 = wrap(imgNum2)
            ang3 = wrap(imgNum3)

            if (lastRot == 0 && ang1 != ang2) { //clockwise first (opposite if flip==1)
              if (true) {
                highlightedColors = counter(ang1, ang2);
              } else {
                highlightedColors = counter(ang2, ang1);
              }
            } else {
              if (true) {
                highlightedColors = counter(ang2, ang1);
              } else {
                highlightedColors = counter(ang1, ang2);
              }
            }
            if (ang2 != ang3 && LastLock == 0) { //clockwise first (opposite if flip==1)
              if (lastRot == 0) {
                highlightedColors = highlightedColors.concat(counter(ang3, ang1))
              } else {
                highlightedColors = highlightedColors.concat(counter(ang1, ang3))
              }
            } else if (ang2 != ang3) {
              if (lastRot == 0) {
                highlightedColors = highlightedColors.concat(counter(ang3, ang1))
              } else {
                highlightedColors = highlightedColors.concat(counter(ang1, ang3))
              }
            }
            highlightedColors = wrap(highlightedColors);

            howdy = trialStruct.itemT_col;
            if (true) {
              if (highlightedColors.includes(wrap(howdy))) {
                encap = 1
              }
            } else {
              if (highlightedColors.includes(wrap(180 - howdy))) {
                encap = 1
              }
            }
            if (angleDeg2 == angleDeg3 & curError != 0) {
              encap = 0
            }

            UniqueLen = highlightedColors.filter(function(val, i, arr) {
              return arr.indexOf(val) === i;
            }).length;

            pointsB = (UniqueLen - 360) / (1 - 360);
            if (pointsB < 0 || encap == 0) {
              pointsB = 0;
            }

            pointsSum = pointsA + pointsB;
            pointsSum = pointsSum.toFixed(2);
            points = points + (pointsSum * .01);

            if (pointsSum >= 1.50) {
              feedText = 'Amazing!<br>(+ ' + pointsSum + '&#x00A2)';
            } else if (pointsSum >= 1.00) {
              feedText = 'Good!<br>(+ ' + pointsSum + '&#x00A2)';
            } else {
              feedText = '(+ ' + pointsSum + '&#x00A2)';
            }
            document.getElementById("fixation").innerHTML = feedText;
            $("#continuousReport").hide();
            $(document).unbind('click.curTrial');
            $(document).unbind('mousemove.curTrial');
            $(document).unbind('mousedown.curTrial');
            $(document).unbind('mouseup.curTrial');
            trialStruct.rt3 = (new Date()) - startTime;
            trialStruct.conf2 = diffAng2;
            trialStruct.conf3 = diffAng3;

            if (trialStruct.isPractice) {
              $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg.!)<br><br>Click to continue.");

              imgNum = Math.round(wrap([angleDeg - randrotate]));
              start(ctx3, imgNum, 80, 100, 200, 200, flip, imgA, itemA);
              // imgNum = flip == 0? Math.round(trialStruct.itemT_col) : Math.round(wrap([180-trialStruct.itemT_col]));
              imgNum = Math.round(trialStruct.itemT_col);
              start(ctx4, imgNum, 40, 100, 200, 200, flip, imgA, itemA);

              $('#feedback').show();
              setTimeout(function() {
                $(document).bind('click.feedback', function() {
                  flip = Math.round(Math.random());
                  randrotate = Math.floor(Math.random() * 360);
                  $('#feedback').hide();
                  document.getElementById("fixation").innerHTML = '+';
                  $(document).unbind('click.feedback');
                  NextTrial();
                  return;
                });
              }, 500); // why do I need a timeout function here? i have no idea
            } else {
              $('#showTrial').show();
              if (repeat == 1) {
                imgPop.src = $('#' + trialStruct.itemT_id)[0].src;
                numRepeats++;
              } else if (currentFeedTrial < numTrialsPerPart[1] - 1) {
                imgA.src = $('#' + r_totalTrials[currentPart][currentFeedTrial + 1].itemT_id)[0].src;
                // imgB.src = $('#' + r_totalTrials[currentPart][currentFeedTrial+1].itemB)[0].src;
              } else if (currentFeedTrial >= numTrialsPerPart[currentPart] - 1) {
                /* this is to prepare the gray square in explicit test */
                imgA.src = $('#999')[0].src;
                // imgB.src = $('#999')[0].src;
              }

              setTimeout(function() {
                flip = Math.round(Math.random());
                randrotate = Math.floor(Math.random() * 360);
                NextTrial();
                document.getElementById("fixation").innerHTML = '+';
              }, feedbackTime);
            }
          }
        } else {
          ctx2a.clearRect(0, 0, 600, 600); // erases the black highlighting
          // ctx2b.clearRect(0,0,600,600); // erases the black highlighting

          pointsA = (curError - 45) / (0 - 45);
          if (pointsA < 0) {
            pointsA = 0;
          }

          encap = 0;
          imgNum2 = Math.round(wrap([angleDeg2 - randrotate]));
          ang1 = wrap(imgNum)
          ang2 = wrap(imgNum2)
          ang3 = wrap(imgNum3)

          if (lastRot == 0 && ang1 != ang2) { //clockwise first (opposite if flip==1)
            if (true) {
              highlightedColors = counter(ang1, ang2);
            } else {
              highlightedColors = counter(ang2, ang1);
            }
          } else {
            if (true) {
              highlightedColors = counter(ang2, ang1);
            } else {
              highlightedColors = counter(ang1, ang2);
            }
          }
          if (ang2 != ang3 && LastLock == 0) { //clockwise first (opposite if flip==1)
            if (lastRot == 0) {
              highlightedColors = highlightedColors.concat(counter(ang3, ang1))
            } else {
              highlightedColors = highlightedColors.concat(counter(ang1, ang3))
            }
          } else if (ang2 != ang3) {
            if (lastRot == 0) {
              highlightedColors = highlightedColors.concat(counter(ang3, ang1))
            } else {
              highlightedColors = highlightedColors.concat(counter(ang1, ang3))
            }
          }
          highlightedColors = wrap(highlightedColors);

          howdy = trialStruct.itemT_col;
          if (true) {
            if (highlightedColors.includes(wrap(howdy))) {
              encap = 1
            }
          } else {
            if (highlightedColors.includes(wrap(howdy + 180))) {
              encap = 1
            }
          }
          if (angleDeg2 == angleDeg3 & curError != 0) {
            encap = 0
          }

          UniqueLen = highlightedColors.filter(function(val, i, arr) {
            return arr.indexOf(val) === i;
          }).length;

          totConfidence.push(UniqueLen);

          pointsB = (UniqueLen - 360) / (1 - 360);
          if (pointsB < 0 || encap == 0) {
            pointsB = 0;
          }

          pointsSum = pointsA + pointsB;
          pointsSum = pointsSum.toFixed(2);
          points = points + (pointsSum * .01);

          if (pointsSum >= 1.50) {
            feedText = 'Amazing!<br>(+ ' + pointsSum + '&#x00A2)';
          } else if (pointsSum >= 1.00) {
            feedText = 'Good!<br>(+ ' + pointsSum + '&#x00A2)';
          } else {
            feedText = '(+ ' + pointsSum + '&#x00A2)';
          }
          document.getElementById("fixation").innerHTML = feedText;
          $("#continuousReport").hide();
          $(document).unbind('click.curTrial');
          $(document).unbind('mousemove.curTrial');
          $(document).unbind('mousedown.curTrial');
          $(document).unbind('mouseup.curTrial');
          trialStruct.rt3 = (new Date()) - startTime;
          trialStruct.conf2 = diffAng2;
          trialStruct.conf3 = diffAng3;

          if (trialStruct.isPractice) {
            $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg.!)<br><br>Click to continue.");

            imgNum = Math.round(wrap([angleDeg - randrotate]));
            start(ctx3, imgNum, 80, 100, 200, 200, flip, imgA, itemA);
            imgNum = flip == 0 ? Math.round(trialStruct.itemT_col) : Math.round(wrap([180 - trialStruct.itemT_col]));
            start(ctx4, imgNum, 40, 100, 200, 200, flip, imgA, itemA);

            $('#feedback').show();
            setTimeout(function() {
              $(document).bind('click.feedback', function() {
                flip = Math.round(Math.random());
                randrotate = Math.floor(Math.random() * 360);
                $('#feedback').hide();
                document.getElementById("fixation").innerHTML = '+';
                $(document).unbind('click.feedback');
                NextTrial();
                return;
              });
            }, 500); // why do I need a timeout function here? i have no idea
          } else {
            $('#showTrial').show();
            if (repeat == 1) {
              imgPop.src = $('#' + trialStruct.itemT_id)[0].src;
              numRepeats++;
            } else if (currentFeedTrial < numTrialsPerPart[1] - 1) {
              imgA.src = $('#' + r_totalTrials[currentPart][currentFeedTrial + 1].itemT_id)[0].src;
              // imgB.src = $('#' + r_totalTrials[currentPart][currentFeedTrial+1].itemB)[0].src;
            } else if (currentFeedTrial >= numTrialsPerPart[currentPart] - 1) {
              /* this is to prepare the gray square in explicit test */
              imgA.src = $('#999')[0].src;
              // imgB.src = $('#999')[0].src;
            }

            setTimeout(function() {
              flip = Math.round(Math.random());
              randrotate = Math.floor(Math.random() * 360);
              NextTrial();
              document.getElementById("fixation").innerHTML = '+';
            }, feedbackTime);
          }
        }
      });
    }

    /* Survey: Regularities Code */
    function Survey() {
      if (document.getElementById("surveyresponseRand").checked) {
        radioResp = 1;
      } else if (document.getElementById("surveyresponsePref").checked) {
        radioResp = 2;
      }
      //proceed only if they picked one of two options
      if (radioResp > 0) {
        $('#instructions').hide();

        // Now they have answered our multiple-coice question
        $("#survey2").hide();
        survey = 1;

        /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
        // if (left_or_right == 1) {
        ringctxA.restore();
        ringctxA.drawImage(ringImg, 50, 50, 500, 500);
        ringctxA.save();
        // } else {
        //   ringctxB.restore();
        //   ringctxB.drawImage(ringImg,0,0,280,280);
        //   ringctxB.save();
        // }

        if (radioResp == 1) {
          document.getElementById("underText").innerHTML =
            "We actually did manipulate what colors were presented. Specifically, 40% of objects were sampled from one quarter of the color wheel (90 degree region). Please select the range of colors you think matches our preferential color sampling.";
        } else if (radioResp == 2) {
          document.getElementById("underText").innerHTML =
            "Yes, we did manipulate what colors were presented. Specifically, 40% of objects were sampled from one quarter of the color wheel (90 degree region). Please select the range of colors you think matches our preferential color sampling.";
        }

        ShowContinuousReport({
          mean: seed[0],
          type: "color",
          isPractice: 0,
          items: 999
        });

        alert(document.getElementById("underText").innerHTML);
        mouseMoved = 0;
      } else {
        alert('Please select an option.');
      }
    }

    /* Survey: Aware? */
    function Survey1() {
      $('#survey1').show();
    }

    /* Survey: Regularities? */
    function Survey2() {
      $('#survey1').hide();
      $("#survey2").show();
    }

    /* Survey: Confidence? */
    function Survey3() {
      $('#survey3').show();
    }

    /* Done with the experiment*/
    function Done() {
      // wait for comments and for them to hit Save
      //proceed only if they picked an option for survey3
      // if (document.querySelector('input[name="likertz"]:checked').value > 0) {
      // likertAns = document.querySelector('input[name="likertz"]:checked').value;
      $("#survey1").hide();
      $('#done').show();
      let cashpoints = points + basepay;
      document.getElementById("cashPrize").innerHTML = "Total earnings: $" + cashpoints.toFixed(2);
      points = points.toFixed(2); //round to 2 decimal places
      /* } else {
          alert('Please select an option.');
      } */
    }

    /* What to save and put it on server */
    function SaveData() {
      $('#done').children().hide();
      $('#saving').show();
      $('#assignmentId').val(GetAssignmentId());
      const newDate = new Date();
      const d = {
        "WORKERID": WORKERID,
        "ASSIGNMENTID": ASSIGNMENTID,
        "curTime": newDate.today() + " @ " + newDate.timeNow(),
        "startExpTime": startExpTime,
        "endExpTime": newDate,
        "totalExpTime": newDate - startExpTime,
        "userAgent": navigator.userAgent,
        "windowWidth": $(window).width(),
        "windowHeight": $(window).height(),
        "screenWidth": screen.width,
        "screenHeight": screen.height,
        "comments": $('#comments').val(),
        "strategy": $('#strategy').val(),
        "pracTrials": r_totalTrials[0],
        "studyTrials": r_totalTrials[1],
        "testTrials": r_totalTrials[2],
        "radioResponse": radioResp,
        "explicitColor": explicitColor,
        "LikertAns": likertAns,
        "Bonus": points,
        "Seeds": seed,
        "StudyOrder": [dx.testimgA, dx.testimgB],
        "leftColor": dx.imgAcolor,
        "rightColor": dx.imgBcolor,
        "colorChange": dx.sign,
        "totConfidence": totConfidence,
        "firstConfDir": lastRotMat,
        "tooFastCount": tooFast,
        "Age": age,
        "Sex": sex
      };

      /* save to Firebase server */
      const blob = new Blob([JSON.stringify(d)], {
        type: "application/json"
      });
      const storageRef = firebase.storage().ref('intergroup/' + WORKERID + '.json');
      storageRef.put(blob);

      document.getElementById("saving").innerHTML = "Submitting...";

      /* submit after waiting a few seconds to make sure data got sent */
      setTimeout(function() {
        document.forms[0].submit();
      }, 3000);
    }

    /* draw images on screen */
    function start(context, deg, initX, initY, imgWidth, imgHeight, flip, image, itemID) {
      flip == 0 ? colors = origColors : colors = flippedColors;
      var col = [146.83, 146.83, 146.83]; // luminance-corrected gray
      if (deg != 'gray') {
        deg = (deg >= 360) ? deg - 360 : deg;
        deg = (deg < 0) ? deg + 360 : deg;
        col = colors[deg];
      }
      if (context == ctx3 || context == ctx4) {
        context.drawImage(image, initX, initY, imgWidth, imgHeight);
        recolor(context, Math.round(col[0]), Math.round(col[1]), Math.round(col[2]), initX, initY, itemID);
      } else {
        image.onload = function() {
          context.drawImage(image, initX, initY, imgWidth, imgHeight);
          recolor(context, Math.round(col[0]), Math.round(col[1]), Math.round(col[2]), initX, initY, itemID);
        }
        recolor(context, Math.round(col[0]), Math.round(col[1]), Math.round(col[2]), initX, initY, itemID);
      }
    }

    /* color images on screen */
    function recolor(context, newR, newG, newB, initX, initY, itemID) {
      imgData = context.getImageData(initX, initY, itemID.width, itemID.height);
      let data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        let red = data[i];
        let green = data[i + 1];
        let blue = data[i + 2];
        if (red > 5 && blue < 200) {
          data[i] = newR;
          data[i + 1] = newG;
          data[i + 2] = newB;
        }
      }
      context.putImageData(imgData, initX, initY);
    }

    /* Make number between 0 and 360: */
    function wrap(v) {
      for (let i = 0; i < v.length; i++) {
        if (v[i] > 360) {
          v[i] -= 360;
        }
        if (v[i] < 0) {
          v[i] += 360;
        }
      }
      if (v.length == undefined) {
        if (v > 360) {
          v -= 360;
        }
        if (v < 0) {
          v += 360;
        }
        v = parseInt(v); // v becomes integer and not array
      }
      return v;
    }

    /* Deg difference in color space*/
    function wrapDiff(input, comparison) {
      if (input < comparison) {
        a = input;
        b = comparison
      } else {
        a = comparison;
        b = input
      }
      degree = Math.abs(a - b);
      if (degree > 180) {
        degree = Math.abs(a - (b - 360))
      }
      if (degree < -180) {
        degree = Math.abs(a - (b + 360))
      }
      return wrap(degree);
    }

    /*check all images are loaded before starting*/
    function ImagesReady() {
      setTimeout(function() { // dont start the check at the same time as the document is loading
        var totImages = 0;
        var readyLoad = 0;
        while (readyLoad == 0) {
          for (let k = 0; k < AllImages.length; k++) {
            if ($('#Obj' + AllImages[k])[0] != null) {
              if ($('#Obj' + AllImages[k])[0].complete) {
                totImages++;
              }
            }
          }
          if (totImages >= AllImages.length) {
            readyLoad = 1;
          } else {
            totImages = 0;
          }
        }
        $('#loading').hide();
        $('a#TextButton').show();
      }, 3000);
    };

    /* running on IE? */
    function isIE() {
      ua = navigator.userAgent;
      var is_ie = ua.indexOf("MSIE ") > -1 || ua.indexOf("Trident/") > -1;
      return is_ie;
    }

    /* check if Safari, IE, or mobile */
    $(function() {
      if (!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/)) { // if Safari
        $('body').html('Unfortunately this experiment does not work in Safari. It works in Chrome, Firefox, or Opera. Sorry!');
      } else if (isIE()) { // if IE
        $('body').html('Unfortunately this HIT does not work in Internet Explorer. It works in Chrome, Firefox, or Opera. Sorry!');
      } else if (
        /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i
        .test(navigator.userAgent) ||
        /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i
        .test(navigator.userAgent.substr(0, 4))) {
        $('body').html('Unfortunately this experiment does not work on mobile devices. It works on desktop versions of Chrome, Firefox, or Opera. Sorry!'); // dont allow mobile
      }
    });
  </script>
</body>

</html>
